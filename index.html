<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Esp√≠a en Ja√©n 2026</title>
    <style>
        :root { --p: #2E7D32; --s: #81C784; --gold: #FFD700; --red: #d32f2f; --dark: #0b1a2a; }
        body { font-family: 'Segoe UI', sans-serif; text-align: center; margin: 0; background: var(--dark); color: white; min-height: 100vh; display: flex; flex-direction: column; }
        .screen { display: none; flex-direction: column; align-items: center; padding: 10px; flex: 1; box-sizing: border-box; }
        .active { display: flex; }

        .main-card { background: rgba(0,0,0,0.85); padding: 15px; border-radius: 20px; border: 2px solid var(--s); width: 95%; max-width: 400px; display: flex; flex-direction: column; gap: 8px; position: relative; }
        
        /* Footer de Apoyo */
        .support-footer { font-size: 0.65rem; color: rgba(255,255,255,0.6); margin-top: auto; padding: 15px; background: rgba(0,0,0,0.3); width: 100%; box-sizing: border-box; }
        .support-footer a { color: var(--gold); text-decoration: none; font-weight: bold; }

        /* Wanted Frame */
        .wanted-container { width: 280px; height: 380px; position: relative; margin: 10px auto; background: url('wanted_frame.png') no-repeat center/contain; display: flex; flex-direction: column; align-items: center; }
        .wanted-photo { width: 160px; height: 160px; object-fit: cover; border: 3px solid #3d2b1f; transform: rotate(-1deg); margin-top: 55px; background: white; }
        .wanted-name { font-family: 'Courier New', serif; font-weight: bold; color: #3d2b1f; margin-top: 20px; font-size: 1.4rem; }

        /* Retos */
        .reto-item { background: #eee; padding: 8px; border-radius: 10px; color: #333; font-size: 0.7rem; cursor: pointer; position: relative; }
        .reto-item.active-reto { background: var(--s); color: white; }
        .reto-item.inactive-reto { opacity: 0.3; }
        .reto-item.inactive-reto::after { content: "‚úï"; position: absolute; top:0; left:0; width:100%; height:100%; display:flex; align-items:center; justify-content:center; color:var(--red); font-size:1.5rem; font-weight:bold; }

        .btn { border: none; padding: 12px; border-radius: 12px; font-weight: bold; width: 100%; cursor: pointer; margin-top: 5px; }
        .cat-btn { background: #333; padding: 8px; border-radius: 10px; font-size: 0.75rem; border: 2px solid transparent; cursor: pointer; color: white; }
        .cat-btn.selected { background: var(--p); border-color: var(--gold); }
        .cat-btn.disabled { opacity: 0.4; cursor: not-allowed; }
        
        .repaso-list { text-align: left; background: rgba(255,255,255,0.1); border-radius: 15px; padding: 10px; width: 100%; box-sizing: border-box; }
        .repaso-item { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; font-size: 0.8rem; }
        .repaso-item img { width: 30px; height: 30px; border-radius: 50%; border: 1px solid var(--gold); }
    </style>
</head>
<body>

<div id="s1" class="screen active">
    <div class="main-card">
        <h1 style="font-size:1.3rem; color:var(--gold); margin:0;">üïµÔ∏è ESP√çA EN JA√âN</h1>
        <div id="lista-previa" style="display:flex; justify-content:center; gap:5px; flex-wrap:wrap; min-height:35px;"></div>
        
        <input type="text" id="in-nombre" placeholder="Nombre..." style="padding:10px; border-radius:10px; border:none;">
        
        <div class="cat-grid" style="display:grid; grid-template-columns:1fr 1fr; gap:5px;">
            <div class="cat-btn" id="cat-infantil" onclick="fijarCat('infantil')">üë∂ Infantil <span>(4-6)</span></div>
            <div class="cat-btn" id="cat-junior" onclick="fijarCat('junior')">üéÆ Junior <span>(7-12)</span></div>
            <div class="cat-btn" id="cat-adolescente" onclick="fijarCat('adolescente')">üì± Adolescente <span>(13-17)</span></div>
            <div class="cat-btn" id="cat-adulto" onclick="fijarCat('adulto')">üç∫ Adulto <span>(+18)</span></div>
        </div>

        <div style="display:flex; gap:5px;">
            <button class="btn" style="background:#444; color:white; flex:1;" onclick="iniciarCamara()">üì∏ SELFIE</button>
            <button class="btn" style="background:var(--p); color:white; flex:1;" onclick="usarAvatar()">üë§ AVATAR</button>
        </div>
        <button class="btn" id="btn-next" style="display:none; background:var(--gold); color:black;" onclick="irARetos()">JUGAR üöÄ</button>
    </div>
</div>

<div id="s-cam" class="screen" style="background:black; justify-content:center;">
    <video id="v" style="width:90%; border-radius:20px; transform: scaleX(-1);" autoplay playsinline></video>
    <button class="btn" onclick="capturarFoto()" style="background:white; color:black; border-radius:50%; width:70px; height:70px;">üì∏</button>
</div>

<div id="s-retos" class="screen">
    <div class="main-card" style="background:white; color:#333">
        <h3>üéØ Retos de Pistas</h3>
        <div id="grid-retos" style="display:grid; grid-template-columns:repeat(5,1fr); gap:8px"></div>
        <button class="btn" style="background:var(--p); color:white; margin-top:15px" onclick="comenzarPartida()">EMPEZAR</button>
    </div>
</div>

<div id="s-game" class="screen"></div>

<div class="support-footer">
    üì¨ Contacto: <b>molinsan.jl@gmail.com</b> | 
    ‚òï Apoya el proyecto: <a href="https://www.paypal.me/7moli" target="_blank">PayPal (7moli)</a>
</div>

<script>
    const niveles = {
        infantil: [{p:"PERRO üê∂", s:"LOBO üê∫"}, {p:"SOL ‚òÄÔ∏è", s:"LUNA üåô"}],
        junior: [{p:"F√öTBOL", s:"BALONCESTO"}], adolescente: [{p:"TIKTOK", s:"REELS"}], adulto: [{p:"TAPAS", s:"VINO"}]
    };
    for(let n in niveles) while(niveles[n].length<100) niveles[n].push({p: niveles[n][0].p+niveles[n].length, s: niveles[n][0].s});

    const ciudadesJaen = [
        {n:"And√∫jar", c:"¬øSab√≠as que es el lugar con m√°s linces ib√©ricos del mundo?"},
        {n:"√öbeda", c:"Es Patrimonio de la Humanidad por su incre√≠ble arquitectura renacentista."},
        {n:"Baeza", c:"Aqu√≠ el poeta Antonio Machado paseaba mientras daba clases."},
        {n:"Martos", c:"Se la conoce como la Ciudad de la Pe√±a y del Aceite."},
        {n:"Linares", c:"Es mundialmente famosa por sus torneos de ajedrez."}
    ];

    const poolRetos = [{t:"M√çMICA",i:"ü§∏"},{t:"DIBUJO",i:"üé®"},{t:"SONIDOS",i:"üê∂"},{t:"BAILE",i:"üíÉ"},{t:"ROBOT",i:"ü§ñ"},{t:"CANTO",i:"üé§"},{t:"PALABRA",i:"üó£Ô∏è"},{t:"ESTATUA",i:"üóø"},{t:"AIRE",i:"üí®"},{t:"SUSURRO",i:"ü§´"}];

    let jugadores=[], categoria='', catFijada=false, stream, partida={};

    function fijarCat(c) {
        if(catFijada) return;
        categoria = c; catFijada = true;
        document.querySelectorAll('.cat-btn').forEach(b => {
            b.classList.add('disabled');
            if(b.id === 'cat-'+c) b.classList.add('selected'), b.classList.remove('disabled');
        });
    }

    async function iniciarCamara() {
        if(!categoria) return alert("Elige nivel");
        stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}});
        document.getElementById('v').srcObject = stream;
        mostrar('s-cam');
    }

    function capturarFoto() {
        const v=document.getElementById('v'), c=document.createElement('canvas');
        c.width=200; c.height=200;
        const ctx=c.getContext('2d'); ctx.translate(200,0); ctx.scale(-1,1); ctx.drawImage(v,0,0,200,200);
        addJ(c.toDataURL());
        stream.getTracks().forEach(t=>t.stop());
        mostrar('s1');
    }

    function usarAvatar() {
        if(!categoria) return alert("Elige nivel");
        const c = document.createElement('canvas'); c.width=200; c.height=200;
        const ctx = c.getContext('2d');
        ctx.fillStyle = '#'+Math.floor(Math.random()*16777215).toString(16); ctx.fillRect(0,0,200,200);
        ctx.font = "100px serif"; ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillText("üïµÔ∏è", 100, 110);
        addJ(c.toDataURL());
    }

    function addJ(img) {
        const nom = (document.getElementById('in-nombre').value || "Jugador").toUpperCase();
        jugadores.push({nombre: nom, foto: img, puntos: 0, medallas: []});
        document.getElementById('lista-previa').innerHTML += `<img src="${img}" style="width:30px; height:30px; border-radius:50%; border:1px solid var(--gold)">`;
        document.getElementById('in-nombre').value = "";
        if(jugadores.length>=3) document.getElementById('btn-next').style.display="block";
    }

    function irARetos() {
        const gr = document.getElementById('grid-retos');
        gr.innerHTML = "";
        poolRetos.forEach((r,i) => gr.innerHTML += `<div id="reto-${i}" class="reto-item active-reto" onclick="this.classList.toggle('active-reto'); this.classList.toggle('inactive-reto');"><b>${r.i}</b><br>${r.t}</div>`);
        mostrar('s-retos');
    }

    function comenzarPartida() {
        const retosFinales = [];
        poolRetos.forEach((r, i) => { if(document.getElementById(`reto-${i}`).classList.contains('active-reto')) retosFinales.push(r); });
        
        let pool = niveles[categoria];
        let pObj = pool[Math.floor(Math.random()*pool.length)];
        jugadores.forEach(j => j.retoAsignado = retosFinales[Math.floor(Math.random()*retosFinales.length)]);
        partida = { p: pObj, espiaIdx: Math.floor(Math.random()*jugadores.length), turno: 0 };
        verTurno();
    }

    function verTurno() {
        mostrar('s-game');
        const j = jugadores[partida.turno];
        document.getElementById('s-game').innerHTML = `<div class="main-card" onclick="revelar()"><img src="${j.foto}" style="width:80px; border-radius:50%; margin:auto;"><br><h2>${j.nombre}</h2><p>PULSA PARA VER</p></div>`;
    }

    function revelar() {
        const j = jugadores[partida.turno], esE = (partida.turno === partida.espiaIdx);
        let msg = esE ? (categoria === 'infantil' ? "PISTA: "+partida.p.s : "ERES EL ESP√çA") : partida.p.p;
        document.getElementById('s-game').innerHTML = `<div class="main-card" style="border-color:${esE?'red':'green'}"><h1>${msg}</h1><p>TU RETO: ${j.retoAsignado.i} ${j.retoAsignado.t}</p><button class="btn" style="background:var(--p); color:white" onclick="sig()">OK</button></div>`;
    }

    function sig() {
        partida.turno++;
        if(partida.turno < jugadores.length) verTurno();
        else pantallaRepaso();
    }

    function pantallaRepaso() {
        let lista = jugadores.map(j => `<div class="repaso-item"><img src="${j.foto}"><b>${j.nombre}:</b> ${j.retoAsignado.i} ${j.retoAsignado.t}</div>`).join('');
        document.getElementById('s-game').innerHTML = `<div class="main-card"><h3>üì¢ RECUERDA TUS RETOS</h3><div class="repaso-list">${lista}</div><button class="btn" style="background:var(--gold); color:black" onclick="pantallaVotacion()">¬°A ACTUAR!</button></div>`;
    }

    function pantallaVotacion() {
        const botones = jugadores.map((j,i) => `<button class="btn" style="background:#444; color:white" onclick="resultadoFinal(${i})">${j.nombre}</button>`).join('');
        document.getElementById('s-game').innerHTML = `<div class="main-card"><h2>üó≥Ô∏è VOTACI√ìN</h2>${botones}</div>`;
    }

    function resultadoFinal(idx) {
        const ganoGente = (idx === partida.espiaIdx);
        const espia = jugadores[partida.espiaIdx];
        
        // Entregar medalla de Ja√©n
        const ciudad = ciudadesJaen[Math.floor(Math.random()*ciudadesJaen.length)];
        const ganadorRonda = ganoGente ? jugadores[0] : espia; 
        ganadorRonda.puntos += 10;
        ganadorRonda.medallas.push(ciudad.n);

        document.getElementById('s-game').innerHTML = `
            <div class="main-card">
                <h2 style="color:${ganoGente?'var(--s)':'var(--red)'}">${ganoGente?'¬°CAZADO!':'¬°ESCUPIDO!'}</h2>
                <div class="wanted-container"><img src="${espia.foto}" class="wanted-photo"><div class="wanted-name">${espia.nombre}</div></div>
                <div style="background:var(--gold); color:black; padding:5px; border-radius:10px; font-size:0.7rem;"><b>üéÅ Regalo:</b> Medalla de ${ciudad.n}. ${ciudad.c}</div>
                <div style="display:flex; gap:5px;"><button class="btn" style="background:var(--s); color:white" onclick="comenzarPartida()">REPETIR</button><button class="btn" style="background:var(--gold); color:black" onclick="location.reload()">FINALIZAR</button></div>
            </div>`;
    }

    function mostrar(id){ document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
</script>
</body>
</html>
