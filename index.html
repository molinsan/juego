<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EspÃ­a en JaÃ©n</title>
    <style>
        :root { --p: #2E7D32; --s: #81C784; --dark: #0b1a2a; --gold: #FFD700; --red: #d32f2f; --paper: #f4e4bc; }
        body { font-family: 'Segoe UI', sans-serif; text-align: center; margin: 0; background: var(--dark); color: white; min-height: 100vh; display: flex; flex-direction: column; overflow-x: hidden; }
        .screen { display: none; flex: 1; flex-direction: column; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
        .active { display: flex; }
        #s1, #s-podio-final { background: linear-gradient(rgba(0,0,0,0.85), rgba(0,0,0,0.85)), url('https://images.unsplash.com/photo-1518107616385-ad308331e9ad?q=80&w=1000') center/cover; }
        .card { background: white; color: #333; padding: 25px; border-radius: 30px; width: 100%; max-width: 400px; box-shadow: 0 15px 35px rgba(0,0,0,0.5); }
        .btn { background: var(--p); color: white; border: none; padding: 18px; border-radius: 20px; font-size: 1.2rem; font-weight: bold; width: 90%; cursor: pointer; margin: 10px 0; }
        .wanted-card { background: var(--paper); color: #3d2b1f; padding: 20px; border: 4px solid #3d2b1f; border-radius: 10px; width: 250px; margin: 20px auto; }
        .wanted-img { width: 180px; height: 180px; object-fit: cover; border: 2px solid #3d2b1f; filter: sepia(0.8) contrast(1.2); }
        .regalo-anim { font-size: 7rem; cursor: pointer; animation: bounce 1s infinite; filter: drop-shadow(0 0 15px var(--gold)); margin: 20px 0; }
        @keyframes bounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .aura-color { width: 130px; height: 130px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 15px auto; font-size: 5rem; border: 8px solid rgba(0,0,0,0.1); }
        .perfil-img { width: 65px; height: 65px; border-radius: 50%; border: 3px solid var(--s); margin: 5px; object-fit: cover; background: #222; }
        #final-team-photo { background: rgba(255,255,255,0.1); border-radius: 20px; padding: 20px; display: flex; flex-wrap: wrap; justify-content: center; align-items: flex-end; gap: 15px; width: 95%; backdrop-filter: blur(5px); }
        .player-final { text-align: center; position: relative; margin-bottom: 10px; }
        .player-final img { width: 85px; height: 85px; border-radius: 50%; border: 3px solid white; object-fit: cover; }
        .medal-tag { background: var(--gold); color: black; font-size: 0.55rem; padding: 2px 4px; border-radius: 4px; font-weight: bold; margin-top: -12px; position: relative; z-index: 2; border: 1px solid #333; display: inline-block; max-width: 80px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .footer-datos { margin-top: auto; padding: 15px; font-size: 0.7rem; color: #888; border-top: 1px solid #333; width: 100%; box-sizing: border-box; background: rgba(0,0,0,0.5); }
        .footer-datos a { color: var(--s); text-decoration: none; }
    </style>
</head>
<body>

<div id="s1" class="screen active">
    <div style="background: rgba(0,0,0,0.85); padding: 25px; border-radius: 40px; width: 90%; max-width: 400px; border: 2px solid var(--s);">
        <h1 style="color:var(--s); margin:0;">ğŸ•µï¸â€â™‚ï¸ EspÃ­a en JaÃ©n</h1>
        <p style="color:var(--gold); font-size: 0.8rem; letter-spacing: 1px;">PROYECTO CIUDADES DE ANDALUCÃA</p>
        <div id="lista-jugadores" style="display:flex; flex-wrap:wrap; justify-content:center; margin:15px 0;"></div>
        <input type="text" id="in-nombre" placeholder="Nombre del explorador..." style="padding:15px; border-radius:15px; width:80%; margin-bottom:10px; text-align:center; border:none; font-size:1rem;">
        <button class="btn" onclick="abrirCamara()">ğŸ“¸ SELFIE EXPLORADOR</button>
        <button class="btn" onclick="iniciarJuego()" style="background:var(--gold); color:black;">ğŸš€ JUGAR AHORA</button>
        <div class="footer-datos">ğŸ“§ molinsan.jl@gmail.com | â˜• <a href="https://paypal.me/7moli" target="_blank">paypal.me/7moli</a></div>
    </div>
</div>

<div id="s-cam" class="screen">
    <video id="camera-feed" style="width:100%; max-width:380px; transform:scaleX(-1); border-radius:20px; border:3px solid var(--gold);" autoplay playsinline muted></video>
    <button class="btn" onclick="tomarFoto()">ğŸ“¸ Â¡CLICK!</button>
</div>

<div id="s-game" class="screen"></div>

<div id="s-podio-final" class="screen">
    <h1 style="color:var(--gold); margin-bottom:10px;">ğŸ‰ EQUIPO ESPÃA EN JAÃ‰N ğŸ‰</h1>
    <div id="final-team-photo"></div>
    <button class="btn" onclick="compartirWhatsApp()" style="background:#25D366">ğŸŸ¢ Compartir en WhatsApp</button>
    <button class="btn" onclick="location.reload()" style="margin-top:10px; background:#444;">ğŸ® NUEVA PARTIDA</button>
</div>

<script>
    const db = [
        {p:"ACEITUNA", e:"ğŸ«’", c:"#558b2f"}, {p:"LAGARTO", e:"ğŸ¦", c:"#81c784"}, 
        {p:"CATEDRAL", e:"â›ª", c:"#ffe082"}, {p:"CASTILLO", e:"ğŸ°", c:"#8d6e63"},
        {p:"ANDAS", e:"ğŸ™Œ", c:"#5d4037"}, {p:"OLIVO", e:"ğŸŒ³", c:"#33691e"}
    ];

    const pueblosJaen = [
        "Albanchez de MÃ¡gina", "AlcalÃ¡ la Real", "Alcaudete", "Aldeaquemada", "AndÃºjar", "Arjona", "Arjonilla", "Arquillos", "Arroyo del Ojanco", "Baeza", "BailÃ©n", "BaÃ±os de la Encina", "Beas de Segura", "Bedmar y GarcÃ­ez", "BegÃ­jar", "BÃ©lmez de la Moraleda", "Benatae", "Cabra del Santo Cristo", "Cambil", "Campillo de Arenas", "Canena", "Carboneros", "CÃ¡rcheles", "La Carolina", "Castellar", "Castillo de LocubÃ­n", "Cazalilla", "Cazorla", "Chiclana de Segura", "ChilluÃ©var", "EscaÃ±uela", "Espeluy", "Frailes", "Fuensanta de Martos", "Fuerte del Rey", "GÃ©nave", "La Guardia de JaÃ©n", "GuarromÃ¡n", "Higuera de Calatrava", "Hinojares", "Hornos", "Huelma", "Huesa", "Ibros", "La Iruela", "Iznatoraf", "Jabalquinto", "JaÃ©n", "Jamilena", "Jimena", "JÃ³dar", "Lahiguera", "Larva", "Linares", "Lopera", "LupiÃ³n", "Mancha Real", "Marmolejo", "Martos", "MengÃ­bar", "MontizÃ³n", "Navas de San Juan", "Noalejo", "Orcera", "Peal de Becerro", "Pegalajar", "Porcuna", "Pozo AlcÃ³n", "Puente de GÃ©nave", "La Puerta de Segura", "Quesada", "Rus", "Sabiote", "Santa Elena", "Santiago de la Espada", "Santiago-Pontones", "Santisteban del Puerto", "Santo TomÃ©", "Segura de la Sierra", "Siles", "Sorianos", "Sorihuela del Guadalimar", "Torre del Campo", "Torreblascopedroso", "Torredonjimeno", "Torreperogil", "Torres", "Torres de AlbÃ¡nchez", "Ãšbeda", "ValdepeÃ±as de JaÃ©n", "Vilches", "Villacarrillo", "Villanueva de la Reina", "Villanueva del Arzobispo", "Villardompardo", "Los Villares", "Villarrodrigo", "Villatorres"
    ];

    let jugadores = [];
    let partida = {};
    let streamMedia;
    let historialPueblosSesion = [];

    function mostrar(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    async function abrirCamara() {
        if(!document.getElementById('in-nombre').value) return alert("Escribe tu nombre");
        try {
            streamMedia = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
            document.getElementById('camera-feed').srcObject = streamMedia;
            mostrar('s-cam');
        } catch(e) { alert("Error de cÃ¡mara."); }
    }

    function tomarFoto() {
        const v = document.getElementById('camera-feed');
        const c = document.createElement('canvas');
        c.width = 400; c.height = 400;
        const ctx = c.getContext('2d');
        ctx.translate(400,0); ctx.scale(-1,1);
        ctx.drawImage(v,0,0,400,400);
        
        let disponibles = pueblosJaen.filter(p => !jugadores.some(j => j.pueblo === p) && !historialPueblosSesion.includes(p));
        if (disponibles.length === 0) { historialPueblosSesion = []; disponibles = pueblosJaen.filter(p => !jugadores.some(j => j.pueblo === p)); }
        
        const pueblo = disponibles[Math.floor(Math.random()*disponibles.length)];
        historialPueblosSesion.push(pueblo);
        
        jugadores.push({ nombre: document.getElementById('in-nombre').value.toUpperCase(), foto: c.toDataURL('image/jpeg'), pueblo: pueblo, puntos: 0, votos: 0 });
        if(streamMedia) streamMedia.getTracks().forEach(t => t.stop());
        document.getElementById('in-nombre').value = "";
        actualizarLista(); mostrar('s1');
    }

    function actualizarLista() {
        document.getElementById('lista-jugadores').innerHTML = jugadores.map(j => `<div style="margin:5px; text-align:center;"><img src="${j.foto}" class="perfil-img"><br><span class="medal-tag">${j.pueblo}</span></div>`).join('');
    }

    function iniciarJuego() {
        if(jugadores.length < 3) return alert("MÃ­nimo 3 exploradores");
        partida = { obj: db[Math.floor(Math.random()*db.length)], espiaIdx: Math.floor(Math.random()*jugadores.length), turno: 0, vIdx: 0 };
        mostrar('s-game'); prepararTurno();
    }

    function prepararTurno() {
        const j = jugadores[partida.turno];
        document.getElementById('s-game').innerHTML = `<div class="card" onclick="revelar()"><h1>${j.nombre}</h1><p>Medalla de <b>${j.pueblo}</b></p><div style="font-size:5rem;">ğŸ§­</div><p>TOCA PARA TU MISIÃ“N</p></div>`;
    }

    function revelar() {
        const esE = (partida.turno === partida.espiaIdx);
        document.getElementById('s-game').innerHTML = `<div class="card" style="border:8px solid ${esE?'#d32f2f':'#2e7d32'}"><div style="background:${esE?'#444':partida.obj.c};" class="aura-color">${esE?'ğŸ—ºï¸':'ğŸ§­'}</div><h2>${esE?'Â¡ERES EL ESPÃA!':'Ruta: '+partida.obj.p}</h2><p>${esE?'Finge conocer el camino...':'Â¡Clave revelada!'}</p><button class="btn" onclick="sigTurno()">LISTO âœ…</button></div>`;
    }

    function sigTurno() {
        partida.turno++;
        if(partida.turno < jugadores.length) prepararTurno();
        else { partida.vIdx = 0; lanzarVoto(); }
    }

    function lanzarVoto() {
        const votante = jugadores[partida.vIdx];
        let btns = jugadores.map((s, idx) => idx !== partida.vIdx ? `<button class="btn" onclick="votar(${idx})">${s.nombre} (${s.pueblo})</button>` : "").join('');
        document.getElementById('s-game').innerHTML = `<div class="card"><h2>${votante.nombre}</h2><p>Â¿QuiÃ©n es el espÃ­a de JaÃ©n?</p>${btns}</div>`;
    }

    function votar(idx) {
        jugadores[idx].votos++;
        partida.vIdx++;
        if(partida.vIdx < jugadores.length) lanzarVoto();
        else mostrarWanted();
    }

    function mostrarWanted() {
        const culpable = [...jugadores].sort((a,b) => b.votos - a.votos)[0];
        document.getElementById('s-game').innerHTML = `<div class="wanted-card"><h2>SE BUSCA</h2><img src="${culpable.foto}" class="wanted-img"><h3>${culpable.nombre}</h3><p>Visto en ${culpable.pueblo}</p></div><button class="btn" onclick="evaluar()" style="background:var(--gold); color:black;">ğŸ’° COBRAR RECOMPENSA</button>`;
    }

    function evaluar() {
        const masV = [...jugadores].sort((a,b) => b.votos - a.votos)[0];
        const esE = (jugadores.indexOf(masV) === partida.espiaIdx);
        if(esE) jugadores.forEach((j,i) => { if(i!==partida.espiaIdx) j.puntos+=10; });
        else jugadores[partida.espiaIdx].puntos+=20;
        document.getElementById('s-game').innerHTML = `<h1 style="color:var(--gold)">Â¡TESORO ENCONTRADO!</h1><div class="regalo-anim" onclick="finalizar()">ğŸ</div><p>Abrir para ver el podio final</p>`;
    }

    function finalizar() {
        for(let i=0; i<20; i++) {
            const a = document.createElement('div'); a.innerHTML = 'ğŸ«’'; a.style.position = 'fixed'; a.style.left = Math.random()*100+'vw'; a.style.top = '-50px'; a.style.fontSize = '2.5rem'; a.style.zIndex="100"; a.style.transition = 'top 2.5s linear'; document.body.appendChild(a);
            setTimeout(() => a.style.top = '100vh', 10); setTimeout(() => a.remove(), 2600);
        }
        mostrar('s-podio-final'); generarFoto();
    }

    function generarFoto() {
        const max = Math.max(...jugadores.map(j => j.puntos));
        const perdedor = jugadores.reduce((prev, curr) => (prev.puntos < curr.puntos ? prev : curr));
        document.getElementById('final-team-photo').innerHTML = jugadores.map(j => `
            <div class="player-final">
                <img src="${j.foto}">
                <div class="medal-tag">${j.pueblo}</div>
                ${j.puntos === max ? '<span style="font-size:2rem; position:absolute; top:-15px; right:-10px;">ğŸ†</span>' : (j === perdedor ? '<span style="font-size:3.5rem; position:absolute; top:-35px; left:50%; transform:translateX(-50%); z-index:10;">ğŸ¦</span>' : '<span style="font-size:1.8rem; position:absolute; bottom:20px; right:-10px;">ğŸ«’</span>')}
                <div style="font-size:0.75rem; font-weight:bold;">${j.nombre}</div>
            </div>`).join('');
    }

    function compartirWhatsApp() {
        const texto = `ğŸ•µï¸â€â™‚ï¸ Â¡Jugamos a EspÃ­a en JaÃ©n! ğŸ«’\nğŸ† Exploradores de toda la provincia.\nğŸ¦ El Lagarto se ha merendado al perdedor...\nÂ¡Juega aquÃ­ con nosotros!`;
        window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(texto)}`, '_blank');
    }
</script>
</body>
</html>
