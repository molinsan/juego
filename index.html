<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>M√≠mica Andaluc√≠a PRO</title>
    <style>
        :root { --p: #2E7D32; --s: #81C784; --dark: #0b1a2a; --gold: #FFD700; }
        body { font-family: 'Segoe UI', sans-serif; text-align: center; margin: 0; background: var(--dark); color: white; overflow: hidden; }
        .screen { display: none; height: 100vh; flex-direction: column; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
        .active { display: flex; }
        .card { background: white; color: #333; padding: 20px; border-radius: 20px; width: 95%; max-width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .btn { background: var(--p); color: white; border: none; padding: 15px; border-radius: 15px; font-size: 1.1rem; font-weight: bold; width: 85%; cursor: pointer; margin: 8px 0; }
        
        /* RECORTE DE IMAGEN */
        .sprite-container { 
            width: 200px; height: 200px; margin: 10px auto; 
            border-radius: 15px; border: 4px solid var(--p); 
            overflow: hidden; background: #eee; position: relative;
        }
        #v-sprite { position: absolute; width: 600px; height: 800px; display: block; } 

        .perfil-img { width: 60px; height: 60px; border-radius: 50%; border: 3px solid var(--s); object-fit: cover; margin: 5px; }
        #camera-feed { width: 100%; border-radius: 20px; transform: scaleX(-1); }

        /* CARTEL WANTED */
        .wanted-container {
            background-image: url('wanted_frame.png');
            background-size: contain; background-repeat: no-repeat; background-position: center;
            width: 350px; height: 450px; display: flex; flex-direction: column; align-items: center;
        }
        .wanted-photo-frame { width: 190px; height: 190px; margin-top: 105px; overflow: hidden; border: 2px solid #3d2b1f; }
        .wanted-photo-frame img { width: 100%; height: 100%; object-fit: cover; filter: sepia(0.8); }
        .mision-tag { background: #fff3cd; color: #856404; padding: 8px; border-radius: 10px; font-weight: bold; margin-top: 10px; border: 1px solid #ffeeba; }
    </style>
</head>
<body>

<div id="s1" class="screen active">
    <h1 style="color:var(--s)">üè∞ Proyecto Andaluc√≠a</h1>
    <div id="lista-jugadores"></div>
    <input type="text" id="in-nombre" placeholder="Nombre..." style="padding:12px; border-radius:10px; width:70%; border:none;">
    <button class="btn" style="background:var(--s); color:black" onclick="abrirCamara()">üì∏ A√ëADIR JUGADOR</button>
    <select id="select-nivel" style="padding:10px; margin-top:10px; width:75%; border-radius:10px;">
        <option value="exploradores">üçº Exploradores</option>
        <option value="junior">üéí Junior</option>
        <option value="adulto">üç∑ Adulto</option>
    </select>
    <button class="btn" onclick="iniciarJuego()">¬°EMPEZAR! üöÄ</button>
</div>

<div id="s-cam" class="screen">
    <video id="camera-feed" autoplay playsinline></video>
    <button class="btn" onclick="tomarFoto()">CAPTURAR üì∏</button>
</div>

<div id="s2" class="screen">
    <div id="tap-card" class="card" onclick="revelarPalabra()">
        <h2 id="turno-de"></h2>
        <p>TOCA PARA VER TU SECRETO</p>
    </div>
    <div id="info-card" class="card" style="display:none">
        <h3 id="msg-rol"></h3>
        <div class="sprite-container" id="box-imagen">
            <img id="v-sprite" src="">
        </div>
        <h2 id="v-palabra" style="color:var(--p)"></h2>
        <div class="mision-tag">MODO: <span id="v-mision"></span></div>
        <button class="btn" style="margin-top:15px" onclick="terminarTurno()">HECHO ‚úÖ</button>
    </div>
</div>

<div id="s-ajugar" class="screen">
    <h1 style="font-size:4rem; color:var(--gold)">¬°A JUGAR!</h1>
    <p>Haced vuestra m√≠mica con vuestros modos secretos...</p>
    <button class="btn" onclick="mostrarVotacion()">¬°TERMINAMOS! (A VOTAR) üó≥Ô∏è</button>
</div>

<div id="s-voto" class="screen">
    <div class="card">
        <h2 id="votante-nombre"></h2>
        <p>¬øQui√©n es el esp√≠a?</p>
        <div id="botones-voto"></div>
    </div>
</div>

<div id="s-wanted" class="screen">
    <h2 id="titulo-wanted">EL M√ÅS VOTADO ES...</h2>
    <div class="wanted-container">
        <div class="wanted-photo-frame"><img id="wanted-img" src=""></div>
        <h2 id="wanted-nombre" style="color:#3d2b1f; margin-top:10px; font-family:serif"></h2>
    </div>
    <div id="resultado-final" style="margin-top:10px"></div>
    <button class="btn" onclick="location.reload()">NUEVA PARTIDA üîÑ</button>
</div>

<script>
    const db = {
        exploradores: ["GATO", "PERRO", "PATO", "CONEJO", "COCHE", "ELEFANTE", "PELOTA", "SOL", "LUNA", "PLATANO", "MANZANA", "FLOR"],
        junior: ["BOMBERO", "POLICIA", "ASTRONAUTA", "PIRATA", "DINOSAURIO", "DRAGON", "MAGO", "SUPERHEROE", "CHEF", "FUTBOLISTA", "CIENTIFICO", "EXPLORADOR"],
        adulto: ["CAFE", "PIZZA", "HIPOTECA", "RESACA", "TRABAJO", "VIAJE", "GIMNASIO", "COMPRA", "MOVIL", "RELOJ", "DORMIR", "DINERO"]
    };
    const listaMisiones = ["üêå C√°mara Lenta", "üîä Haciendo Ruidos", "üñêÔ∏è Solo Manos", "ü§ñ Como un Robot", "üëÉ Con la Nariz", "üíÉ Bailando", "üò¥ Con mucho sue√±o"];

    let jugadores = [];
    let partida = {};
    let stream;

    function mostrar(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    async function abrirCamara() {
        mostrar('s-cam');
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
        document.getElementById('camera-feed').srcObject = stream;
    }

    function tomarFoto() {
        const video = document.getElementById('camera-feed');
        const canvas = document.createElement('canvas');
        canvas.width = 300; canvas.height = 300;
        const ctx = canvas.getContext('2d');
        ctx.translate(300, 0); ctx.scale(-1, 1);
        ctx.drawImage(video, 0, 0, 300, 300);
        jugadores.push({ nombre: document.getElementById('in-nombre').value.toUpperCase(), foto: canvas.toDataURL(), votos: 0 });
        stream.getTracks().forEach(t => t.stop());
        document.getElementById('in-nombre').value = "";
        actualizarLista(); mostrar('s1');
    }

    function actualizarLista() {
        document.getElementById('lista-jugadores').innerHTML = jugadores.map(j => `<img src="${j.foto}" class="perfil-img">`).join('');
    }

    function iniciarJuego() {
        if(jugadores.length < 3) return alert("M√≠nimo 3 personas");
        const nivel = document.getElementById('select-nivel').value;
        const listaPalabras = db[nivel];
        
        // Asignar misiones √∫nicas a cada uno
        let misionesMezcladas = [...listaMisiones].sort(() => Math.random() - 0.5);

        partida = { 
            nivel, 
            palabra: listaPalabras[Math.floor(Math.random()*listaPalabras.length)],
            espiaIdx: Math.floor(Math.random()*jugadores.length),
            turno: 0,
            votanteIdx: 0,
            misionesAsignadas: jugadores.map((_, i) => misionesMezcladas[i % misionesMezcladas.length])
        };
        partida.idxPalabra = listaPalabras.indexOf(partida.palabra);
        mostrar('s2'); prepararTurno();
    }

    function prepararTurno() {
        document.getElementById('turno-de').innerText = "TURNO: " + jugadores[partida.turno].nombre;
        document.getElementById('tap-card').style.display = "block";
        document.getElementById('info-card').style.display = "none";
    }

    function revelarPalabra() {
        const esEspia = (partida.turno === partida.espiaIdx);
        document.getElementById('tap-card').style.display = "none";
        document.getElementById('info-card').style.display = "block";
        const sprite = document.getElementById('v-sprite');
        
        // Asignar la misi√≥n individual
        document.getElementById('v-mision').innerText = partida.misionesAsignadas[partida.turno];

        if(esEspia) {
            document.getElementById('msg-rol').innerText = "ü§´ ERES EL ESP√çA";
            document.getElementById('v-palabra').innerText = "¬°DISIMULA!";
            document.getElementById('box-imagen').style.display = "none";
        } else {
            document.getElementById('msg-rol').innerText = "TU PALABRA ES:";
            document.getElementById('v-palabra').innerText = partida.palabra;
            document.getElementById('box-imagen').style.display = "block";
            sprite.src = `./${partida.nivel}1-12.jpeg`;
            
            const col = partida.idxPalabra % 3;
            const fila = Math.floor(partida.idxPalabra / 3);
            sprite.style.left = `-${col * 200}px`;
            sprite.style.top = `-${fila * 200}px`;
        }
    }

    function terminarTurno() {
        partida.turno++;
        if(partida.turno < jugadores.length) prepararTurno();
        else mostrar('s-ajugar');
    }

    function mostrarVotacion() {
        mostrar('s-voto');
        prepararVotacionIndividual();
    }

    function prepararVotacionIndividual() {
        const votante = jugadores[partida.votanteIdx];
        document.getElementById('votante-nombre').innerText = votante.nombre + ", ¬øqui√©n crees que es?";
        const box = document.getElementById('botones-voto');
        box.innerHTML = "";
        jugadores.forEach((suspect, idx) => {
            if(idx !== partida.votanteIdx) {
                const b = document.createElement('button');
                b.className = "btn"; b.innerText = suspect.nombre;
                b.onclick = () => {
                    jugadores[idx].votos++;
                    partida.votanteIdx++;
                    if(partida.votanteIdx < jugadores.length) prepararVotacionIndividual();
                    else mostrarWanted();
                };
                box.appendChild(b);
            }
        });
    }

    function mostrarWanted() {
        const culpable = [...jugadores].sort((a,b) => b.votos - a.votos)[0];
        const esEspiaReal = (jugadores.indexOf(culpable) === partida.espiaIdx);
        const espiaRealNombre = jugadores[partida.espiaIdx].nombre;
        
        document.getElementById('wanted-img').src = culpable.foto;
        document.getElementById('wanted-nombre').innerText = culpable.nombre;
        
        let mensaje = esEspiaReal ? 
            `<h2 style='color:var(--s)'>¬°LO HAB√âIS PILLADO! üéâ</h2><p>Efectivamente, ${culpable.nombre} era el esp√≠a.</p>` : 
            `<h2 style='color:red'>¬°HAB√âIS FALLADO! üò±</h2><p>${culpable.nombre} era inocente. El esp√≠a real era <b>${espiaRealNombre}</b>.</p>`;
        
        document.getElementById('resultado-final').innerHTML = mensaje;
        mostrar('s-wanted');
    }
</script>
</body>
</html>






