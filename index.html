<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EspÃ­a en JaÃ©n 2026</title>
    <style>
        :root { --p: #2E7D32; --s: #81C784; --gold: #FFD700; --red: #d32f2f; --dark: #0b1a2a; }
        body { font-family: 'Segoe UI', sans-serif; text-align: center; margin: 0; background: var(--dark); color: white; min-height: 100vh; overflow-x: hidden; }
        .screen { display: none; flex-direction: column; align-items: center; padding: 10px; min-height: 100vh; box-sizing: border-box; }
        .active { display: flex; }

        .main-card { background: rgba(0,0,0,0.85); padding: 15px; border-radius: 20px; border: 2px solid var(--s); width: 95%; max-width: 400px; display: flex; flex-direction: column; gap: 8px; }
        
        .cat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
        .cat-btn { background: #333; padding: 8px; border-radius: 10px; font-size: 0.75rem; border: 2px solid transparent; cursor: pointer; color: white; }
        .cat-btn.selected { background: var(--p); border-color: var(--gold); }
        .cat-btn.disabled { opacity: 0.4; cursor: not-allowed; }
        .cat-btn span { display: block; font-size: 0.6rem; opacity: 0.7; }

        /* Estilos Retos */
        .reto-item { background: #eee; padding: 8px; border-radius: 10px; color: #333; font-size: 0.7rem; cursor: pointer; border: 2px solid transparent; transition: 0.2s; position: relative; }
        .reto-item.active-reto { background: var(--s); color: white; border-color: var(--p); }
        .reto-item.inactive-reto { opacity: 0.4; }
        .reto-item.inactive-reto::after { content: "âœ•"; position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: var(--red); font-size: 1.5rem; font-weight: bold; }

        /* Wanted Frame */
        .wanted-container { width: 280px; height: 380px; position: relative; margin: 10px auto; background: url('wanted_frame.png') no-repeat center/contain; display: flex; flex-direction: column; align-items: center; }
        .wanted-photo { width: 160px; height: 160px; object-fit: cover; border: 3px solid #3d2b1f; transform: rotate(-1deg); margin-top: 55px; background: white; }
        .wanted-name { font-family: 'Courier New', serif; font-weight: bold; color: #3d2b1f; margin-top: 20px; font-size: 1.4rem; }

        .btn { border: none; padding: 12px; border-radius: 12px; font-weight: bold; width: 100%; cursor: pointer; margin-top: 5px; }
        
        .podio-layout { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; padding: 15px; }
        .player-card { background: linear-gradient(135deg, #f9d976, #f39c12); border-radius: 15px; padding: 10px; width: 130px; color: #333; position: relative; border: 2px solid var(--gold); }
        .player-card img { width: 100%; border-radius: 10px; background: white; }
        .medal-tag { background: rgba(0,0,0,0.1); font-size: 0.55rem; border-radius: 4px; padding: 2px; margin-top: 3px; font-weight: bold; }
    </style>
</head>
<body>

<div id="s1" class="screen active">
    <div class="main-card">
        <h1 style="font-size:1.3rem; color:var(--gold);">ğŸ•µï¸ ESPÃA EN JAÃ‰N</h1>
        <div id="lista-previa" style="display:flex; justify-content:center; gap:5px; flex-wrap:wrap; min-height:35px;"></div>
        <input type="text" id="in-nombre" placeholder="Nombre (Pe, Hache...)" style="padding:10px; border-radius:10px; border:none; width:100%; box-sizing:border-box;">
        
        <div style="display:flex; align-items:center; gap:8px; background:rgba(255,255,255,0.05); padding:5px; border-radius:10px;">
            <div style="display:grid; grid-template-columns:repeat(5, 1fr); gap:5px; flex:1;">
                <div class="av-item" onclick="selAv(this,'ğŸŒˆ')" style="font-size:1.5rem; cursor:pointer;">ğŸŒˆ</div>
                <div class="av-item" onclick="selAv(this,'ğŸ‘®')" style="font-size:1.5rem; cursor:pointer;">ğŸ‘®</div>
                <div class="av-item" onclick="selAv(this,'ğŸ‘¨â€ğŸš’')" style="font-size:1.5rem; cursor:pointer;">ğŸ‘¨â€ğŸš’</div>
                <div class="av-item" onclick="selAv(this,'ğŸ¦')" style="font-size:1.5rem; cursor:pointer;">ğŸ¦</div>
                <div class="av-item" onclick="selAv(this,'ğŸ«’')" style="font-size:1.5rem; cursor:pointer;">ğŸ«’</div>
            </div>
            <input type="color" id="avatar-color" value="#ffffff" style="width:35px; height:35px; border:none; background:none;">
        </div>

        <div class="cat-grid">
            <div class="cat-btn" id="cat-infantil" onclick="fijarCat('infantil')">ğŸ‘¶ Infantil <span>(4-6 aÃ±os)</span></div>
            <div class="cat-btn" id="cat-junior" onclick="fijarCat('junior')">ğŸ® Junior <span>(7-12 aÃ±os)</span></div>
            <div class="cat-btn" id="cat-adolescente" onclick="fijarCat('adolescente')">ğŸ“± Adolescente <span>(13-17 aÃ±os)</span></div>
            <div class="cat-btn" id="cat-adulto" onclick="fijarCat('adulto')">ğŸº Adulto <span>(+18 aÃ±os)</span></div>
        </div>

        <div style="display:flex; gap:5px;">
            <button class="btn" style="background:#555; color:white; flex:1;" onclick="iniciarCamara()">ğŸ“¸ SELFIE</button>
            <button class="btn" style="background:var(--p); color:white; flex:1;" onclick="usarAvatar()">ğŸ‘¤ AVATAR</button>
        </div>
        <button class="btn" id="btn-next" style="display:none; background:var(--gold); color:black;" onclick="irARetos()">SIGUIENTE ğŸš€</button>
    </div>
</div>

<div id="s-cam" class="screen" style="background:black; justify-content:center;">
    <video id="v" style="width:90%; border-radius:20px; transform: scaleX(-1);" autoplay playsinline></video>
    <button class="btn" onclick="capturarFoto()" style="background:white; color:black; border-radius:50%; width:70px; height:70px;">ğŸ“¸</button>
</div>

<div id="s-retos" class="screen">
    <div class="main-card" style="background:white; color:#333">
        <h3>ğŸ¯ Retos de Pistas</h3>
        <p style="font-size:0.7rem">Toca para tachar o activar.</p>
        <div id="grid-retos" style="display:grid; grid-template-columns:repeat(5,1fr); gap:8px"></div>
        <button class="btn" style="background:var(--p); color:white; margin-top:15px" onclick="comenzarPartida()">Â¡EMPEZAR!</button>
    </div>
</div>

<div id="s-game" class="screen"></div>

<script>
    const niveles = {
        infantil: [{p:"PERRO ğŸ¶", s:"LOBO ğŸº"}, {p:"SOL â˜€ï¸", s:"LUNA ğŸŒ™"}, {p:"CASA ğŸ ", s:"TIENDA â›º"}],
        junior: [{p:"MINECRAFT", s:"ROBLOX"}], adolescente: [{p:"TIKTOK", s:"REELS"}], adulto: [{p:"ACEITE", s:"VINO"}]
    };
    for(let n in niveles) while(niveles[n].length<100) niveles[n].push({p: niveles[n][0].p+niveles[n].length, s: niveles[n][0].s});

    const poolRetos = [{t:"MÃMICA",i:"ğŸ¤¸"},{t:"DIBUJO",i:"ğŸ¨"},{t:"SONIDOS",i:"ğŸ¶"},{t:"BAILE",i:"ğŸ’ƒ"},{t:"ROBOT",i:"ğŸ¤–"},{t:"CANTO",i:"ğŸ¤"},{t:"1 PALABRA",i:"ğŸ—£ï¸"},{t:"ESTATUA",i:"ğŸ—¿"},{t:"AIRE",i:"ğŸ’¨"},{t:"SUSURRO",i:"ğŸ¤«"}];

    let jugadores=[], categoria='', catFijada=false, avatarActivo='ğŸŒˆ', stream, partida={};

    function selAv(el, icon) {
        document.querySelectorAll('.av-item').forEach(i=>i.style.background='none');
        el.style.background = 'rgba(255,255,255,0.2)'; avatarActivo = icon;
    }

    function fijarCat(c) {
        if(catFijada) return;
        categoria = c; catFijada = true;
        document.querySelectorAll('.cat-btn').forEach(b => {
            b.classList.add('disabled');
            if(b.id === 'cat-'+c) b.classList.add('selected'), b.classList.remove('disabled');
        });
    }

    async function iniciarCamara() {
        if(!categoria) return alert("Elige nivel");
        stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}});
        document.getElementById('v').srcObject = stream;
        mostrar('s-cam');
    }

    function capturarFoto() {
        const v=document.getElementById('v'), c=document.createElement('canvas');
        c.width=200; c.height=200;
        const ctx=c.getContext('2d'); ctx.translate(200,0); ctx.scale(-1,1); ctx.drawImage(v,0,0,200,200);
        addJ(c.toDataURL());
        stream.getTracks().forEach(t=>t.stop());
        mostrar('s1');
    }

    function usarAvatar() {
        if(!categoria) return alert("Elige nivel");
        const col = document.getElementById('avatar-color').value;
        const c = document.createElement('canvas'); c.width=200; c.height=200;
        const ctx = c.getContext('2d');
        ctx.fillStyle = col; ctx.fillRect(0,0,200,200);
        ctx.font = "100px serif"; ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillText(avatarActivo, 100, 110);
        addJ(c.toDataURL());
    }

    function addJ(img) {
        const nom = (document.getElementById('in-nombre').value || "Jugador").toUpperCase();
        let acc = nom.includes("PE")?"ğŸŒˆ":nom.includes("HACHE")?"ğŸ‘®":nom.includes("JOTA")?"ğŸ‘¨â€ğŸš’":"";
        jugadores.push({nombre: nom, foto: img, puntos: 0, medallas: [], acc: acc});
        document.getElementById('lista-previa').innerHTML += `<img src="${img}" style="width:30px; height:30px; border-radius:50%; border:1px solid var(--gold)">`;
        document.getElementById('in-nombre').value = "";
        if(jugadores.length>=3) document.getElementById('btn-next').style.display="block";
    }

    function irARetos() {
        const gr = document.getElementById('grid-retos');
        gr.innerHTML = "";
        poolRetos.forEach((r,i) => {
            gr.innerHTML += `<div id="reto-${i}" class="reto-item active-reto" onclick="toggleReto(${i})"><b>${r.i}</b><br>${r.t}</div>`;
        });
        mostrar('s-retos');
    }

    function toggleReto(i) {
        const el = document.getElementById(`reto-${i}`);
        el.classList.toggle('active-reto');
        el.classList.toggle('inactive-reto');
    }

    function comenzarPartida() {
        const retosFinales = [];
        poolRetos.forEach((r, i) => {
            if(document.getElementById(`reto-${i}`).classList.contains('active-reto')) retosFinales.push(r);
        });
        if(retosFinales.length === 0) return alert("Â¡Debes dejar al menos un reto activo!");
        
        let pool = niveles[categoria];
        let pObj = pool[Math.floor(Math.random()*pool.length)];
        jugadores.forEach(j => j.retoAsignado = retosFinales[Math.floor(Math.random()*retosFinales.length)]);
        partida = { p: pObj, espiaIdx: Math.floor(Math.random()*jugadores.length), turno: 0 };
        verTurno();
    }

    function verTurno() {
        mostrar('s-game');
        const j = jugadores[partida.turno];
        document.getElementById('s-game').innerHTML = `
            <div class="main-card" onclick="revelar()">
                <img src="${j.foto}" style="width:100px; border-radius:50%; margin:auto; border:3px solid var(--gold)">
                <h2>${j.nombre}</h2>
                <p>TOCA PARA VER TU SECRETO</p>
            </div>`;
    }

    function revelar() {
        const j = jugadores[partida.turno];
        const esE = (partida.turno === partida.espiaIdx);
        let msg = esE ? (categoria === 'infantil' ? "Pista EspÃ­a: "+partida.p.s : "ERES EL ESPÃA") : partida.p.p;
        document.getElementById('s-game').innerHTML = `
            <div class="main-card" style="border-color:${esE?'red':'green'}">
                <h1 style="font-size:1.8rem;">${msg}</h1>
                <p style="color:var(--gold); font-weight:bold;">RETO: ${j.retoAsignado.i} ${j.retoAsignado.t}</p>
                <button class="btn" style="background:var(--p); color:white" onclick="sig()">ENTENDIDO</button>
            </div>`;
    }

    function sig() {
        partida.turno++;
        if(partida.turno < jugadores.length) verTurno();
        else pantallaVotacion();
    }

    function pantallaVotacion() {
        const botones = jugadores.map((j,i) => `<button class="btn" style="background:#444; color:white" onclick="resultadoFinal(${i})">${j.nombre}</button>`).join('');
        document.getElementById('s-game').innerHTML = `<div class="main-card"><h2>Â¿QuiÃ©n es el EspÃ­a?</h2>${botones}</div>`;
    }

    function resultadoFinal(idx) {
        const ganoGente = (idx === partida.espiaIdx);
        if(ganoGente) jugadores.forEach((j,i) => { if(i !== partida.espiaIdx) j.puntos += 10; });
        else jugadores[partida.espiaIdx].puntos += 20;
        
        const espia = jugadores[partida.espiaIdx];
        document.getElementById('s-game').innerHTML = `
            <div class="main-card">
                <h2 style="color:${ganoGente?'var(--s)':'var(--red)'}">${ganoGente?'Â¡CAZADO!':'Â¡SE ESCAPÃ“!'}</h2>
                <div class="wanted-container"><img src="${espia.foto}" class="wanted-photo"><div class="wanted-name">${espia.nombre}</div></div>
                <div style="display:flex; gap:5px;"><button class="btn" style="background:var(--s); color:white" onclick="comenzarPartida()">OTRA RONDA</button><button class="btn" style="background:var(--gold); color:black" onclick="finalizarPartida()">FINALIZAR</button></div>
            </div>`;
    }

    function mostrar(id){ document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
    function finalizarPartida() { location.reload(); } // Implementar podio si se desea
</script>
</body>
</html>
