<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Un Esp√≠a en Andaluc√≠a</title>
    <style>
        :root { --p: #2E7D32; --s: #81C784; --dark: #0b1a2a; --gold: #FFD700; --white: #ffffff; }
        body { font-family: 'Segoe UI', sans-serif; text-align: center; margin: 0; background: var(--dark); color: var(--white); overflow-x: hidden; }
        .screen { display: none; min-height: 100vh; flex-direction: column; justify-content: center; align-items: center; padding: 15px; box-sizing: border-box; }
        .active { display: flex; }
        #s1 { background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('inicio.jpeg') center/cover; }
        .card { background: white; color: #333; padding: 20px; border-radius: 25px; width: 100%; max-width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); margin: 10px 0; }
        .btn { background: var(--p); color: white; border: none; padding: 15px; border-radius: 15px; font-size: 1.1rem; font-weight: bold; width: 90%; cursor: pointer; margin: 8px 0; }
        .perfil-img { width: 65px; height: 65px; border-radius: 50%; border: 3px solid var(--s); margin: 5px; object-fit: cover; background: #222; }
        .puntos-tag { font-size: 0.8rem; background: var(--gold); color: black; padding: 2px 8px; border-radius: 10px; font-weight: bold; }
        #camera-feed { width: 100%; max-width: 400px; border-radius: 20px; transform: scaleX(-1); background: #000; }
        .ganadores-container { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; }
        .ganador-ronda-box { position: relative; width: 90px; }
        .medalla { position: absolute; top: -10px; right: -5px; font-size: 2rem; z-index: 5; }
        .foto-ganador { width: 80px; height: 80px; border-radius: 50%; border: 3px solid var(--gold); object-fit: cover; }
        .wanted-container { background: url('wanted_frame.png') no-repeat center/contain; width: 260px; height: 320px; display: flex; flex-direction: column; align-items: center; margin: 10px auto; }
        .wanted-photo { width: 145px; height: 145px; margin-top: 82px; object-fit: cover; filter: sepia(0.7); }
    </style>
</head>
<body>

<div id="s1" class="screen active">
    <div style="background: rgba(0,0,0,0.8); padding: 25px; border-radius: 30px; width: 90%; max-width: 450px;">
        <h1 style="color:var(--s); margin:0 0 10px 0;">üïµÔ∏è‚Äç‚ôÇÔ∏è Un Esp√≠a en Andaluc√≠a</h1>
        <div id="lista-jugadores" style="display:flex; flex-wrap:wrap; justify-content:center; margin-bottom:15px;"></div>
        <input type="text" id="in-nombre" placeholder="Tu nombre..." style="padding:15px; border-radius:12px; width:85%; border:none; margin-bottom:15px; font-size:1.1rem;">
        <button class="btn" style="background:var(--s); color:black" onclick="abrirCamara()">üì∏ HACERSE SELFIE</button>
        <select id="select-nivel" style="padding:12px; width:90%; border-radius:12px; margin-top:5px;">
            <option value="exp">üçº Exploradores (4-8)</option>
            <option value="jun">üéí Junior (9-15)</option>
            <option value="ado">üì± Adolescente (16-17)</option>
            <option value="adu">üç∑ Adultos (+18)</option>
        </select>
        <button class="btn" onclick="iniciarJuego()" style="background:var(--gold); color:black; margin-top:20px; font-size:1.3rem;">üöÄ EMPEZAR</button>
    </div>
</div>

<div id="s-cam" class="screen">
    <video id="camera-feed" autoplay playsinline muted></video>
    <button class="btn" onclick="tomarFoto()" style="height:70px; margin-top:20px;">üì∏ ¬°CAPTURAR!</button>
    <button class="btn" style="background:#666" onclick="mostrar('s1')">CANCELAR</button>
</div>

<div id="s-game" class="screen"></div>

<script>
    const db = {
        exp: [{p:"GATO",e:"üê±",pi:"Animal que hace miau"}, {p:"SOL",e:"‚òÄÔ∏è",pi:"Sale de d√≠a"}],
        jun: [{p:"PIRATA",e:"üè¥‚Äç‚ò†Ô∏è",pi:"Busca tesoros"}, {p:"ROBOT",e:"ü§ñ",pi:"Es de metal"}],
        ado: [{p:"TIKTOK",e:"üíÉ",pi:"App de bailes"}, {p:"EXAMEN",e:"üìù",pi:"En el colegio"}],
        adu: [{p:"HIPOTECA",e:"üè†",pi:"Dinero del banco"}, {p:"RESACA",e:"ü§¢",pi:"Tras beber"}]
    };
    const misiones = [{t:"C√°mara Lenta",i:"üêå"},{t:"Robot",i:"ü§ñ"},{t:"Bailando",i:"üíÉ"},{t:"Sin manos",i:"üñêÔ∏èüö´"}];
    
    let jugadores = [];
    let partida = {};
    let streamMedia;

    function mostrar(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    async function abrirCamara() {
        if(!document.getElementById('in-nombre').value) return alert("Escribe tu nombre");
        try {
            streamMedia = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false });
            const video = document.getElementById('camera-feed');
            video.srcObject = streamMedia;
            mostrar('s-cam');
        } catch (err) {
            alert("No se puede acceder a la c√°mara. Aseg√∫rate de dar permisos o usar HTTPS.");
        }
    }

    function tomarFoto() {
        const video = document.getElementById('camera-feed');
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth || 400;
        canvas.height = video.videoHeight || 400;
        const ctx = canvas.getContext('2d');
        
        // Espejo para que el selfie salga como se ve en pantalla
        ctx.translate(canvas.width, 0);
        ctx.scale(-1, 1);
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        const fotoData = canvas.toDataURL('image/jpeg');
        jugadores.push({
            nombre: document.getElementById('in-nombre').value.toUpperCase(),
            foto: fotoData,
            puntos: 0,
            votos: 0
        });

        if (streamMedia) streamMedia.getTracks().forEach(t => t.stop());
        document.getElementById('in-nombre').value = "";
        actualizarLista();
        mostrar('s1');
    }

    function actualizarLista() {
        document.getElementById('lista-jugadores').innerHTML = jugadores.map(j => `
            <div style="margin:5px">
                <img src="${j.foto}" class="perfil-img"><br>
                <b class="puntos-tag">${j.puntos} pts</b>
            </div>`).join('');
    }

    function iniciarJuego() {
        if(jugadores.length < 3) return alert("M√≠nimo 3 jugadores");
        const nivel = document.getElementById('select-nivel').value;
        partida = {
            obj: db[nivel][Math.floor(Math.random()*db[nivel].length)],
            espiaIdx: Math.floor(Math.random()*jugadores.length),
            turno: 0, mTurno: 0, vIdx: 0,
            mAsignadas: jugadores.map((_,i) => misiones[i % misiones.length]).sort(()=>0.5-Math.random())
        };
        mostrar('s-game');
        prepararTurno();
    }

    function prepararTurno() {
        const j = jugadores[partida.turno];
        const cont = document.getElementById('s-game');
        cont.innerHTML = `
            <div class="card" onclick="revelarRol()">
                <h2>TURNO: ${j.nombre}</h2>
                <div style="font-size:4rem">ü§´</div>
                <p>TOCA PARA VER TU SECRETO</p>
            </div>`;
    }

    function revelarRol() {
        const esE = (partida.turno === partida.espiaIdx);
        const cont = document.getElementById('s-game');
        cont.innerHTML = `
            <div class="card">
                <h3>${esE ? "üïµÔ∏è‚Äç‚ôÇÔ∏è ERES EL ESP√çA" : "TU PALABRA:"}</h3>
                <div style="font-size:6rem">${esE ? "‚ùì" : partida.obj.e}</div>
                <h2 style="color:var(--p)">${esE ? "¬°AVER√çGUALO!" : partida.obj.p}</h2>
                <p>${esE ? "<b>PISTA:</b> " + partida.obj.pi : "¬°Mucha suerte!"}</p>
                <button class="btn" onclick="siguienteTurno()">LISTO ‚úÖ</button>
            </div>`;
    }

    function siguienteTurno() {
        partida.turno++;
        if(partida.turno < jugadores.length) prepararTurno();
        else mostrarMisiones();
    }

    function mostrarMisiones() {
        const j = jugadores[partida.mTurno];
        const m = partida.mAsignadas[partida.mTurno];
        const cont = document.getElementById('s-game');
        cont.innerHTML = `
            <div class="card">
                <h2>M√çMICA: ${j.nombre}</h2>
                <div class="modo-box">
                    <div style="font-size:4rem">${m.i}</div>
                    <div style="font-weight:bold">${m.t}</div>
                </div>
                <button class="btn" onclick="sigMision()">SIGUIENTE ‚ñ∂Ô∏è</button>
            </div>`;
    }

    function sigMision() {
        partida.mTurno++;
        if(partida.mTurno < jugadores.length) mostrarMisiones();
        else lanzarVotacion();
    }

    function lanzarVotacion() {
        const votante = jugadores[partida.vIdx];
        const cont = document.getElementById('s-game');
        let btns = jugadores.map((s, idx) => idx !== partida.vIdx ? `<button class="btn" onclick="votar(${idx})">${s.nombre}</button>` : "").join('');
        cont.innerHTML = `<div class="card"><h2>${votante.nombre}, ¬øqui√©n es el esp√≠a?</h2>${btns}</div>`;
    }

    function votar(idx) {
        jugadores[idx].votos++;
        partida.vIdx++;
        if(partida.vIdx < jugadores.length) lanzarVotacion();
        else finalizarRonda();
    }

    function finalizarRonda() {
        const culpable = [...jugadores].sort((a,b) => b.votos - a.votos)[0];
        const esE = (jugadores.indexOf(culpable) === partida.espiaIdx);
        if(esE) { 
            jugadores.forEach((j, i) => { if(i !== partida.espiaIdx) j.puntos += 10; });
        } else {
            jugadores[partida.espiaIdx].puntos += 20;
        }

        const max = Math.max(...jugadores.map(j => j.puntos));
        const ganadores = jugadores.filter(j => j.puntos === max && j.puntos > 0);
        const cont = document.getElementById('s-game');
        
        cont.innerHTML = `
            <h2 style="color:var(--gold)">ü•á L√çDERES</h2>
            <div class="ganadores-container">${ganadores.map(g => `<div class="ganador-ronda-box"><div class="medalla">ü•á</div><img src="${g.foto}" class="foto-ganador"><div>${g.nombre}</div></div>`).join('')}</div>
            <div class="wanted-container"><img src="${culpable.foto}" class="wanted-photo"><b>${culpable.nombre}</b></div>
            <div class="card">
                <p><b>PUNTOS:</b> ${jugadores.map(j=>j.nombre+":"+j.puntos).join(" | ")}</p>
                <button class="btn" onclick="iniciarJuego()">OTRA RONDA üîÑ</button>
                <button class="btn" style="background:#444" onclick="location.reload()">NUEVOS JUGADORES</button>
            </div>`;
    }
</script>
</body>
</html>
