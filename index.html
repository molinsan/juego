<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Esp√≠a en Ja√©n</title>
    <style>
        :root { --p: #2E7D32; --s: #81C784; --dark: #0b1a2a; --gold: #FFD700; --red: #d32f2f; --paper: #f4e4bc; }
        body { font-family: 'Segoe UI', sans-serif; text-align: center; margin: 0; background: var(--dark); color: white; min-height: 100vh; display: flex; flex-direction: column; overflow-x: hidden; }
        .screen { display: none; flex: 1; flex-direction: column; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
        .active { display: flex; }
        #s1, #s-podio-final { background: linear-gradient(rgba(0,0,0,0.85), rgba(0,0,0,0.85)), url('https://images.unsplash.com/photo-1518107616385-ad308331e9ad?q=80&w=1000') center/cover; }
        .card { background: white; color: #333; padding: 25px; border-radius: 30px; width: 100%; max-width: 400px; box-shadow: 0 15px 35px rgba(0,0,0,0.5); }
        .btn { background: var(--p); color: white; border: none; padding: 18px; border-radius: 20px; font-size: 1.2rem; font-weight: bold; width: 90%; cursor: pointer; margin: 10px 0; }
        .wanted-card { background: var(--paper); color: #3d2b1f; padding: 20px; border: 4px solid #3d2b1f; border-radius: 10px; width: 250px; margin: 20px auto; box-shadow: 0 10px 20px rgba(0,0,0,0.5); position: relative; }
        .wanted-img { width: 180px; height: 180px; object-fit: cover; border: 2px solid #3d2b1f; filter: sepia(0.8) contrast(1.2); }
        .perfil-img { width: 55px; height: 55px; border-radius: 50%; border: 2px solid var(--s); margin: 5px; object-fit: cover; }
        #final-team-photo { background: rgba(0,0,0,0.7); border-radius: 20px; padding: 25px; display: flex; flex-wrap: wrap; justify-content: center; align-items: flex-end; gap: 20px; width: 95%; border: 2px solid var(--gold); }
        .player-final { text-align: center; position: relative; margin-bottom: 30px; }
        .player-final img { width: 90px; height: 90px; border-radius: 50%; border: 3px solid white; object-fit: cover; }
        .medal-list { background: var(--gold); color: black; font-size: 0.6rem; padding: 3px 6px; border-radius: 6px; font-weight: bold; margin-top: -12px; position: relative; z-index: 5; display: inline-block; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .regalo-anim { font-size: 6rem; cursor: pointer; animation: bounce 1s infinite; margin: 15px 0; }
        @keyframes bounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.15); } }
    </style>
</head>
<body>

<div id="s1" class="screen active">
    <div style="background: rgba(0,0,0,0.85); padding: 25px; border-radius: 35px; border: 2px solid var(--s); width: 90%; max-width: 400px;">
        <h1 style="color:var(--s); margin:0;">üïµÔ∏è‚Äç‚ôÇÔ∏è Esp√≠a en Ja√©n</h1>
        <p style="color:var(--gold); font-size: 0.8rem; margin-top: 5px;">PROYECTO CIUDADES DE ANDALUC√çA</p>
        <div id="lista-jugadores" style="display:flex; flex-wrap:wrap; justify-content:center; margin:15px 0;"></div>
        <div id="registro-ui">
            <input type="text" id="in-nombre" placeholder="Nombre del explorador..." style="padding:15px; border-radius:15px; width:85%; margin-bottom:12px; text-align:center; border:none; font-size:1rem;">
            <button class="btn" onclick="abrirCamara()">üì∏ HACERME UN SELFIE</button>
        </div>
        <button class="btn" id="btn-iniciar" onclick="iniciarJuego()" style="background:var(--gold); color:black; display:none; margin-top:10px;">üöÄ COMENZAR TORNEO</button>
    </div>
</div>

<div id="s-cam" class="screen">
    <video id="camera-feed" style="width:100%; max-width:380px; transform:scaleX(-1); border-radius:25px; border:3px solid var(--gold);" autoplay playsinline muted></video>
    <button class="btn" onclick="tomarFoto()">üì∏ ¬°FOTO!</button>
</div>

<div id="s-game" class="screen"></div>

<div id="s-podio-final" class="screen">
    <h1 style="color:var(--gold); margin-bottom:15px;">üèÜ REYES DE JA√âN üèÜ</h1>
    <div id="final-team-photo"></div>
    <button class="btn" onclick="location.reload()" style="margin-top:25px; background:#555;">üéÆ NUEVA PARTIDA (BORRAR TODO)</button>
</div>

<script>
    const pueblosJaen = ["Ja√©n", "Bail√©n", "√öbeda", "Baeza", "Linares", "And√∫jar", "Martos", "Alcal√° la Real", "Cazorla", "Ba√±os de la Encina", "La Carolina", "Meng√≠bar", "Segura de la Sierra", "Sabiote", "Alcaudete", "Quesada", "Castellar", "Huelma", "Frailes", "Vilches", "Arjona", "Canena", "Torredonjimeno", "Villanueva del Arzobispo"];
    const palabras = [{p:"ACEITUNA", e:"ü´í"}, {p:"LAGARTO", e:"ü¶é"}, {p:"CATEDRAL", e:"‚õ™"}, {p:"OLIVAR", e:"üå≥"}, {p:"CASTILLO", e:"üè∞"}, {p:"PIPIRRANA", e:"ü•ó"}, {p:"CASTILLO", e:"üè∞"}];
    
    let jugadores = [];
    let partida = {};
    let streamMedia;

    function mostrar(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    async function abrirCamara() {
        if(!document.getElementById('in-nombre').value) return alert("Escribe tu nombre");
        try {
            streamMedia = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
            document.getElementById('camera-feed').srcObject = streamMedia;
            mostrar('s-cam');
        } catch(e) { alert("Error al abrir c√°mara."); }
    }

    function tomarFoto() {
        const v = document.getElementById('camera-feed');
        const c = document.createElement('canvas');
        c.width = 400; c.height = 400;
        const ctx = c.getContext('2d');
        ctx.translate(400,0); ctx.scale(-1,1);
        ctx.drawImage(v,0,0,400,400);
        
        jugadores.push({ 
            nombre: document.getElementById('in-nombre').value.toUpperCase(), 
            foto: c.toDataURL('image/jpeg'), 
            puntos: 0, 
            votos: 0, 
            medallas: [] 
        });
        
        if(streamMedia) streamMedia.getTracks().forEach(t => t.stop());
        document.getElementById('in-nombre').value = "";
        document.getElementById('btn-iniciar').style.display = jugadores.length >= 3 ? "block" : "none";
        actualizarListaPrevia();
        mostrar('s1');
    }

    function actualizarListaPrevia() {
        document.getElementById('lista-jugadores').innerHTML = jugadores.map(j => `
            <div style="text-align:center; margin:5px;">
                <img src="${j.foto}" class="perfil-img">
                <div style="font-size:0.7rem; font-weight:bold; color:var(--s);">${j.puntos} PTS</div>
            </div>`).join('');
    }

    function iniciarJuego() {
        partida = { 
            palabra: palabras[Math.floor(Math.random()*palabras.length)],
            espiaIdx: Math.floor(Math.random()*jugadores.length),
            turno: 0
        };
        jugadores.forEach(j => j.votos = 0);
        prepararTurno();
    }

    function prepararTurno() {
        mostrar('s-game');
        const j = jugadores[partida.turno];
        document.getElementById('s-game').innerHTML = `
            <div class="card" onclick="revelar()">
                <p>Turno de:</p>
                <h1 style="margin:5px 0;">${j.nombre}</h1>
                <div style="font-size:5rem; margin:15px 0;">üß≠</div>
                <p style="color:#666;">TOCA PARA VER TU SECRETO</p>
            </div>`;
    }

    function revelar() {
        const esE = (partida.turno === partida.espiaIdx);
        document.getElementById('s-game').innerHTML = `
            <div class="card" style="border:8px solid ${esE?'var(--red)':'var(--p)'}">
                <div style="font-size:6rem;">${esE?'üó∫Ô∏è':partida.palabra.e}</div>
                <h2>${esE ? '¬°ERES EL ESP√çA!' : partida.palabra.p}</h2>
                <p style="font-size:0.9rem;">${esE ? 'Disimula e intenta descubrir qu√© dicen los dem√°s.' : 'Explica la palabra con pistas sin decir la palabra real.'}</p>
                <button class="btn" onclick="pasarSiguiente()">HECHO ‚úÖ</button>
            </div>`;
    }

    function pasarSiguiente() {
        partida.turno++;
        if(partida.turno < jugadores.length) prepararTurno();
        else { partida.turnoVoto = 0; iniciarVotacion(); }
    }

    function iniciarVotacion() {
        const votante = jugadores[partida.turnoVoto];
        let opciones = jugadores.map((j, idx) => 
            idx !== partida.turnoVoto ? `<button class="btn" onclick="registrarVoto(${idx})" style="padding:12px; margin:5px 0;">${j.nombre}</button>` : ''
        ).join('');
        
        document.getElementById('s-game').innerHTML = `
            <div class="card">
                <h2>VOTA ${votante.nombre}</h2>
                <p>¬øQui√©n crees que es el esp√≠a de esta ruta?</p>
                <div style="display:flex; flex-direction:column;">${opciones}</div>
            </div>`;
    }

    function registrarVoto(idx) {
        jugadores[idx].votos++;
        partida.turnoVoto++;
        if(partida.turnoVoto < jugadores.length) iniciarVotacion();
        else mostrarWanted();
    }

    function mostrarWanted() {
        const culpable = [...jugadores].sort((a,b) => b.votos - a.votos)[0];
        document.getElementById('s-game').innerHTML = `
            <div class="wanted-card">
                <h1 style="margin:5px; font-size:2.5rem; letter-spacing:5px;">WANTED</h1>
                <img src="${culpable.foto}" class="wanted-img">
                <h2 style="margin:10px 0;">${culpable.nombre}</h2>
                <p style="font-size:0.7rem; font-weight:bold;">Visto por √∫ltima vez en los olivares</p>
            </div>
            <button class="btn" onclick="revelarResultado()" style="background:var(--gold); color:black;">¬øHAB√âIS ACERTADO?</button>`;
    }

    function revelarResultado() {
        const masVotado = [...jugadores].sort((a,b) => b.votos - a.votos)[0];
        const esE = (jugadores.indexOf(masVotado) === partida.espiaIdx);
        
        let ganadoresRonda = [];
        if(esE) {
            jugadores.forEach((j, i) => { if(i !== partida.espiaIdx) { j.puntos += 10; ganadoresRonda.push(j); }});
        } else {
            jugadores[partida.espiaIdx].puntos += 20;
            ganadoresRonda.push(jugadores[partida.espiaIdx]);
        }

        ganadoresRonda.forEach(g => {
            const disponibles = pueblosJaen.filter(p => !g.medallas.includes(p));
            const p = disponibles.length > 0 ? disponibles[Math.floor(Math.random()*disponibles.length)] : pueblosJaen[0];
            g.medallas.push(p);
        });

        document.getElementById('s-game').innerHTML = `
            <div class="card">
                <h1 style="color:${esE?'var(--p)':'var(--red)'}">${esE?'¬°CAZADO!':'¬°SE ESCAP√ì!'}</h1>
                <p>El infiltrado era: <b>${jugadores[partida.espiaIdx].nombre}</b></p>
                <div style="background:#f0f0f0; padding:15px; border-radius:20px; margin:15px 0;">
                    <p style="margin:0; font-size:0.8rem; color:#666;">Han ganado medalla:</p>
                    <b style="color:var(--p);">${ganadoresRonda.map(g => g.nombre).join(', ')}</b>
                </div>
                <button class="btn" onclick="iniciarJuego()">üîÑ OTRA RONDA</button>
                <button class="btn" onclick="finalizarTodo()" style="background:#444;">üèÅ FINALIZAR PARTIDA</button>
            </div>`;
    }

    function finalizarTodo() {
        // Lluvia de aceitunas
        for(let i=0; i<25; i++) {
            const a = document.createElement('div'); a.innerHTML = 'ü´í'; a.style.position = 'fixed'; a.style.left = Math.random()*100+'vw'; a.style.top = '-50px'; a.style.fontSize = '2.5rem'; a.style.zIndex="1000"; a.style.transition = 'top 3s linear'; document.body.appendChild(a);
            setTimeout(() => a.style.top = '110vh', 10); setTimeout(() => a.remove(), 3000);
        }

        const maxP = Math.max(...jugadores.map(j => j.puntos));
        const minP = Math.min(...jugadores.map(j => j.puntos));
        const perdedor = jugadores.find(j => j.puntos === minP);

        document.getElementById('final-team-photo').innerHTML = jugadores.map(j => `
            <div class="player-final">
                <img src="${j.foto}">
                ${j.medallas.length > 0 ? `<div class="medal-list">üèÖ ${j.medallas[j.medallas.length-1]}</div>` : '<div class="medal-list">Explorador</div>'}
                ${j.puntos === maxP ? '<span style="position:absolute; top:-15px; right:-15px; font-size:3rem;">üèÜ</span>' : ''}
                ${j === perdedor ? '<span style="position:absolute; top:-35px; left:20%; font-size:4.5rem; z-index:10; filter:drop-shadow(0 0 10px black);">ü¶é</span>' : ''}
                <div style="font-weight:bold; margin-top:8px; font-size:1rem;">${j.nombre}</div>
                <div style="color:var(--gold); font-size:1.2rem; font-weight:bold;">${j.puntos} PTS</div>
                <div style="font-size:0.6rem; color:#aaa;">Pueblos: ${j.medallas.length}</div>
            </div>
        `).join('');
        
        mostrar('s-podio-final');
    }
</script>
</body>
</html>
