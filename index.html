<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Esp√≠a en Ja√©n - Deluxe</title>
    <style>
        :root { --p: #2E7D32; --s: #81C784; --dark: #0b1a2a; --gold: #FFD700; --red: #d32f2f; --paper: #f4e4bc; }
        body { font-family: 'Segoe UI', sans-serif; text-align: center; margin: 0; background: var(--dark); color: white; min-height: 100vh; overflow-x: hidden; }
        .screen { display: none; flex: 1; flex-direction: column; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; min-height: 100vh; }
        .active { display: flex; }
        #s1, #s-podio-final { background: linear-gradient(rgba(0,0,0,0.8), rgba(0,0,0,0.8)), url('https://images.unsplash.com/photo-1518107616385-ad308331e9ad?q=80&w=1000') center/cover; }
        .card { background: white; color: #333; padding: 25px; border-radius: 30px; width: 100%; max-width: 400px; box-shadow: 0 15px 35px rgba(0,0,0,0.5); }
        .btn { background: var(--p); color: white; border: none; padding: 18px; border-radius: 20px; font-size: 1.1rem; font-weight: bold; width: 90%; cursor: pointer; margin: 10px 0; }
        .wanted-container { width: 300px; height: 400px; position: relative; margin: 10px auto; background: url('wanted_frame.png') no-repeat center/contain; }
        .wanted-photo { width: 200px; height: 210px; object-fit: cover; position: absolute; top: 90px; left: 50px; filter: sepia(0.7) contrast(1.2); }
        #final-team-photo { display: flex; flex-wrap: wrap; justify-content: center; align-items: flex-end; gap: 20px; margin-top: 40px; }
        .player-podio { position: relative; text-align: center; margin-bottom: 50px; }
        .img-podio { width: 90px; height: 90px; border-radius: 50%; border: 4px solid white; object-fit: cover; z-index: 5; position: relative; }
        .lagarto-abrazo { position: absolute; font-size: 7rem; top: -50px; left: -25px; z-index: 1; transform: rotate(-10deg); }
        .medal-box { background: var(--gold); color: black; font-size: 0.6rem; font-weight: bold; padding: 4px 8px; border-radius: 10px; margin-top: -10px; position: relative; z-index: 11; }
        .curiosidad { font-size: 0.85rem; color: #555; font-style: italic; margin-top: 10px; background: #fffde7; padding: 10px; border-radius: 10px; border-left: 5px solid var(--gold); }
    </style>
</head>
<body>

<div id="s1" class="screen active">
    <div style="background: rgba(0,0,0,0.85); padding: 25px; border-radius: 35px; border: 2px solid var(--s); width: 95%; max-width: 420px;">
        <h1 style="color:var(--s); margin:0;">üïµÔ∏è‚Äç‚ôÇÔ∏è Esp√≠a en Ja√©n</h1>
        <div id="lista-jugadores" style="display:flex; flex-wrap:wrap; justify-content:center; margin-bottom:15px;"></div>
        <input type="text" id="in-nombre" placeholder="Nombre..." style="padding:12px; border-radius:10px; width:80%; margin-bottom:8px; text-align:center;">
        <input type="number" id="in-edad" placeholder="Edad..." style="padding:12px; border-radius:10px; width:80%; margin-bottom:12px; text-align:center;">
        <button class="btn" onclick="abrirCamara()">üì∏ SELFIE</button>
        <button class="btn" id="btn-play" onclick="iniciarJuego()" style="background:var(--gold); color:black; display:none;">üöÄ EMPEZAR</button>
    </div>
</div>

<div id="s-cam" class="screen"><video id="camera-feed" style="width:100%; max-width:380px; transform:scaleX(-1); border-radius:20px; border:4px solid var(--gold);" autoplay playsinline muted></video><button class="btn" onclick="tomarFoto()">üì∏ ¬°FOTO!</button></div>
<div id="s-game" class="screen"></div>
<div id="s-podio-final" class="screen"><h1 style="color:var(--gold);">üèÜ CLASIFICACI√ìN FINAL üèÜ</h1><div id="final-team-photo"></div><button class="btn" onclick="location.reload()" style="background:#444;">üéÆ REINICIAR</button></div>

<script>
    const pueblosInfo = [
        {n:"Bail√©n", c:"¬°Aqu√≠ se gan√≥ una gran batalla contra Napole√≥n!"},
        {n:"Cazorla", c:"¬°Es el parque natural m√°s grande de Espa√±a!"},
        {n:"√öbeda", c:"Sus edificios parecen sacados de un palacio de Italia."},
        {n:"Baeza", c:"Tiene la fuente m√°s antigua de toda Andaluc√≠a."},
        {n:"Ja√©n", c:"¬°Bajo su catedral vive el famoso Lagarto de Ja√©n!"},
        {n:"Ba√±os de la Encina", c:"Su castillo tiene 14 torres y es s√∫per antiguo."},
        {n:"Linares", c:"All√≠ viv√≠an los antiguos romanos en una ciudad llamada C√°stulo."},
        {n:"Alcal√° la Real", c:"Su fortaleza de la Mota parece de una pel√≠cula de caballeros."}
    ];

    const niveles = {
        infantil: [
            {p:"SOL", e:"‚òÄÔ∏è", s:"üåô"}, {p:"PERRO", e:"üê∂", s:"üê±"}, 
            {p:"COCHE", e:"üöó", s:"üö≤"}, {p:"MANZANA", e:"üçé", s:"üçå"}
        ],
        junior: [{p:"ACEITUNA", e:"ü´í"}, {p:"LAGARTO", e:"ü¶é"}, {p:"CASTILLO", e:"üè∞"}, {p:"OLIVO", e:"üå≥"}],
        adulto: [{p:"PIPIRRANA", e:"ü•ó"}, {p:"ALMAZARA", e:"üè≠"}, {p:"RENACIMIENTO", e:"üèõÔ∏è"}]
    };

    let jugadores = [];
    let usados = [];
    let streamMedia;

    function abrirCamara() {
        if(!document.getElementById('in-nombre').value || !document.getElementById('in-edad').value) return alert("Pon nombre y edad");
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } }).then(s => {
            streamMedia = s; document.getElementById('camera-feed').srcObject = s; mostrar('s-cam');
        });
    }

    function tomarFoto() {
        const v = document.getElementById('camera-feed');
        const c = document.createElement('canvas'); c.width = 400; c.height = 400;
        c.getContext('2d').drawImage(v,0,0,400,400);
        jugadores.push({ 
            nombre: document.getElementById('in-nombre').value.toUpperCase(), 
            edad: parseInt(document.getElementById('in-edad').value), 
            foto: c.toDataURL(), puntos: 0, medallas: [] 
        });
        streamMedia.getTracks().forEach(t => t.stop());
        document.getElementById('btn-play').style.display = jugadores.length >= 3 ? "block" : "none";
        document.getElementById('lista-jugadores').innerHTML += `<img src="${c.toDataURL()}" style="width:45px; height:45px; border-radius:50%; margin:3px; border:2px solid var(--gold);">`;
        mostrar('s1');
    }

    function iniciarJuego() {
        const edadMin = Math.min(...jugadores.map(j => j.edad));
        let pool = (edadMin <= 6) ? niveles.infantil : (edadMin <= 11 ? niveles.junior : niveles.adulto);
        
        let disponibles = pool.filter(w => !usados.includes(w.p));
        if(disponibles.length === 0) { usados = []; disponibles = pool; }
        
        const palabraObj = disponibles[Math.floor(Math.random()*disponibles.length)];
        usados.push(palabraObj.p);

        partida = { palabra: palabraObj, espiaIdx: Math.floor(Math.random()*jugadores.length), turno: 0, esInfantil: (edadMin <= 6) };
        jugadores.forEach(j => j.votos = 0);
        prepararTurno();
    }

    function prepararTurno() {
        mostrar('s-game');
        const j = jugadores[partida.turno];
        document.getElementById('s-game').innerHTML = `<div class="card" onclick="revelar()"><h2>${j.nombre}</h2><div style="font-size:5rem;">üß≠</div><p>TOCA PARA VER</p></div>`;
    }

    function revelar() {
        const esE = (partida.turno === partida.espiaIdx);
        let icono = esE ? 'üó∫Ô∏è' : partida.palabra.e;
        let texto = esE ? '¬°ERES EL ESP√çA!' : partida.palabra.p;
        
        if(esE && partida.esInfantil) { 
            icono = partida.palabra.s; 
            texto = "¬°ERES EL ESP√çA! (Pista parecida)"; 
        }

        document.getElementById('s-game').innerHTML = `
            <div class="card" style="border:8px solid ${esE?'var(--red)':'var(--p)'}">
                <div style="font-size:6rem;">${icono}</div>
                <h2>${texto}</h2>
                <button class="btn" onclick="pasarSiguiente()">OK</button>
            </div>`;
    }

    function pasarSiguiente() {
        partida.turno++;
        if(partida.turno < jugadores.length) prepararTurno();
        else { partida.turnoVoto = 0; votar(); }
    }

    function votar() {
        const v = jugadores[partida.turnoVoto];
        let btns = jugadores.map((j, i) => i !== partida.turnoVoto ? `<button class="btn" onclick="regVoto(${i})">${j.nombre}</button>` : '').join('');
        document.getElementById('s-game').innerHTML = `<div class="card"><h2>${v.nombre}</h2><p>¬øQui√©n es el esp√≠a?</p>${btns}</div>`;
    }

    function regVoto(i) {
        jugadores[i].votos++; partida.turnoVoto++;
        if(partida.turnoVoto < jugadores.length) votar();
        else mostrarWanted();
    }

    function mostrarWanted() {
        const c = [...jugadores].sort((a,b) => b.votos - a.votos)[0];
        document.getElementById('s-game').innerHTML = `
            <div class="wanted-container"><img src="${c.foto}" class="wanted-photo"></div>
            <button class="btn" onclick="resultado()">¬øES √âL?</button>`;
    }

    function resultado() {
        const masV = [...jugadores].sort((a,b) => b.votos - a.votos)[0];
        const esE = (jugadores.indexOf(masV) === partida.espiaIdx);
        let gans = [];
        if(esE) { jugadores.forEach((j, i) => { if(i !== partida.espiaIdx) { j.puntos += 10; gans.push(j); }}); }
        else { jugadores[partida.espiaIdx].puntos += 20; gans.push(jugadores[partida.espiaIdx]); }

        const infoPueblo = pueblosInfo[Math.floor(Math.random()*pueblosInfo.length)];
        gans.forEach(g => g.medallas.push(infoPueblo.n));

        document.getElementById('s-game').innerHTML = `
            <div class="card">
                <h1>${esE?'¬°CAZADO!':'¬°SE ESCAP√ì!'}</h1>
                <p>El esp√≠a era ${jugadores[partida.espiaIdx].nombre}</p>
                <div class="curiosidad"><b>üéÅ Regalo de ${infoPueblo.n}:</b><br>${infoPueblo.c}</div>
                <button class="btn" onclick="iniciarJuego()">OTRA RONDA</button>
                <button class="btn" onclick="finalizar()" style="background:#444;">FIN</button>
            </div>`;
    }

    function finalizar() {
        const maxP = Math.max(...jugadores.map(j => j.puntos));
        const perdedor = jugadores.reduce((prev, curr) => (prev.puntos < curr.puntos) ? prev : curr);
        document.getElementById('final-team-photo').innerHTML = jugadores.map(j => `
            <div class="player-podio">
                ${j === perdedor ? '<div class="lagarto-abrazo">ü¶é</div>' : ''}
                <img src="${j.foto}" class="img-podio">
                <div class="medal-box">${j.medallas[j.medallas.length-1] || 'Explorador'}</div>
                ${j.puntos === maxP ? '<div style="position:absolute; top:-30px; right:0; font-size:2rem;">üèÜ</div>' : ''}
                <div style="font-weight:bold; margin-top:5px; font-size:0.8rem;">${j.nombre}</div>
                <div style="color:var(--gold); font-size:1rem;">${j.puntos} PTS</div>
            </div>`).join('');
        mostrar('s-podio-final');
    }

    function mostrar(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }
</script>
</body>
</html>
