<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Esp√≠a en Ja√©n - Proyecto Andaluc√≠a</title>
    <style>
        :root { --p: #2E7D32; --s: #81C784; --dark: #0b1a2a; --gold: #FFD700; --red: #d32f2f; }
        body { font-family: 'Segoe UI', sans-serif; text-align: center; margin: 0; background: var(--dark); color: white; overflow-x: hidden; }
        .screen { display: none; min-height: 100vh; flex-direction: column; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
        .active { display: flex; }

        /* Fondo Nocturno de Ja√©n */
        #s1, #s-podio { 
            background: linear-gradient(rgba(0,0,0,0.8), rgba(0,0,0,0.8)), 
            url('https://images.unsplash.com/photo-1518107616385-ad308331e9ad?q=80&w=1000') center/cover; 
        }

        .card { background: white; color: #333; padding: 25px; border-radius: 30px; width: 100%; max-width: 400px; box-shadow: 0 15px 35px rgba(0,0,0,0.5); }
        .btn { background: var(--p); color: white; border: none; padding: 18px; border-radius: 20px; font-size: 1.2rem; font-weight: bold; width: 90%; cursor: pointer; margin: 10px 0; }
        
        /* Animaciones del Regalo */
        @keyframes bounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        @keyframes shake { 0% { transform: rotate(0); } 25% { transform: rotate(5deg); } 75% { transform: rotate(-5deg); } }
        .regalo-anim { font-size: 8rem; cursor: pointer; animation: bounce 1s infinite, shake 0.5s infinite; filter: drop-shadow(0 0 20px var(--gold)); margin: 20px 0; }
        
        .aura-color { width: 140px; height: 140px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 15px auto; font-size: 5.5rem; border: 8px solid rgba(0,0,0,0.1); }
        .perfil-img { width: 70px; height: 70px; border-radius: 50%; border: 3px solid var(--s); object-fit: cover; background: #222; margin: 5px; }
        
        /* Podio Final y Lagarto */
        .podio-cont { display: flex; justify-content: center; align-items: flex-end; gap: 10px; margin: 20px 0; }
        .ganador-final { text-align: center; position: relative; }
        .ganador-final img { width: 100px; height: 100px; border-radius: 50%; border: 5px solid var(--gold); object-fit: cover; }
        
        .lagarto-escena { position: relative; width: 220px; height: 220px; margin: 40px auto; }
        .lagarto-img { font-size: 7rem; position: absolute; top: -30px; left: 50%; transform: translateX(-50%); z-index: 2; }
        .perdedor-img { width: 90px; height: 90px; border-radius: 50%; border: 5px solid var(--red); filter: grayscale(0.8) sepia(1) hue-rotate(-50deg); margin-top: 40px; }

        /* Footer con tus datos */
        .footer-datos { margin-top: 20px; font-size: 0.8rem; color: #888; border-top: 1px solid #333; padding-top: 10px; width: 100%; }
        .footer-datos a { color: var(--s); text-decoration: none; font-weight: bold; }
    </style>
</head>
<body>

<div id="s1" class="screen active">
    <div style="background: rgba(0,0,0,0.85); padding: 30px; border-radius: 40px; width: 90%; max-width: 450px; border: 2px solid var(--s);">
        <h1 style="color:var(--s); margin:0;">üïµÔ∏è‚Äç‚ôÇÔ∏è Esp√≠a en Ja√©n</h1>
        <p style="color:var(--gold); font-size: 0.9rem; margin-top: 5px;">PROYECTO CIUDADES DE ANDALUC√çA</p>
        
        <div id="lista-jugadores" style="display:flex; flex-wrap:wrap; justify-content:center; margin:15px 0;"></div>
        
        <input type="text" id="in-nombre" placeholder="Escribe tu nombre..." style="padding:15px; border-radius:15px; width:85%; border:none; margin-bottom:15px; text-align:center; font-size:1.1rem;">
        
        <button class="btn" style="background:var(--s); color:black" onclick="abrirCamara()">üì∏ HACERSE SELFIE</button>
        <button class="btn" onclick="iniciarJuego()" style="background:var(--gold); color:black;">üöÄ EMPEZAR PARTIDA</button>

        <div class="footer-datos">
            üìß <a href="mailto:molinsan.jl@gmail.com">molinsan.jl@gmail.com</a><br>
            ‚òï Apoyo: <a href="https://paypal.me/7moli" target="_blank">paypal.me/7moli</a>
        </div>
    </div>
</div>

<div id="s-cam" class="screen">
    <video id="camera-feed" style="width:100%; max-width:400px; transform:scaleX(-1); border-radius:30px; border: 4px solid var(--gold);" autoplay playsinline muted></video>
    <button class="btn" onclick="tomarFoto()" style="height:80px; margin-top:30px; font-size:1.5rem;">üì∏ ¬°DISPARAR!</button>
</div>

<div id="s-game" class="screen"></div>

<script>
    const db = [
        {p:"ACEITUNA", e:"ü´í", c:"#558b2f"}, {p:"SOL", e:"‚òÄÔ∏è", c:"#ffeb3b"},
        {p:"LAGARTO", e:"ü¶é", c:"#81c784"}, {p:"BOMBERO", e:"üë®‚Äçüöí", c:"#f44336"},
        {p:"POLIC√çA", e:"üëÆ‚Äç‚ôÇÔ∏è", c:"#1a237e"}, {p:"MANZANA", e:"üçé", c:"#ff5252"},
        {p:"CATEDRAL", e:"‚õ™", c:"#ffe082"}, {p:"CASTILLO", e:"üè∞", c:"#8d6e63"}
    ];

    let jugadores = [];
    let partida = {};
    let streamMedia;

    function mostrar(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    async function abrirCamara() {
        if(!document.getElementById('in-nombre').value) return alert("Pon tu nombre");
        try {
            streamMedia = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
            document.getElementById('camera-feed').srcObject = streamMedia;
            mostrar('s-cam');
        } catch(e) { alert("Acceso a c√°mara denegado o no disponible."); }
    }

    function tomarFoto() {
        const v = document.getElementById('camera-feed');
        const c = document.createElement('canvas');
        c.width = 400; c.height = 400;
        const ctx = c.getContext('2d');
        ctx.translate(400, 0); ctx.scale(-1, 1);
        ctx.drawImage(v, 0, 0, 400, 400);
        
        jugadores.push({ 
            nombre: document.getElementById('in-nombre').value.toUpperCase(), 
            foto: c.toDataURL('image/jpeg'), 
            puntos: 0, 
            votos: 0 
        });

        if(streamMedia) streamMedia.getTracks().forEach(t => t.stop());
        document.getElementById('in-nombre').value = "";
        actualizarLista(); 
        mostrar('s1');
    }

    function actualizarLista() {
        document.getElementById('lista-jugadores').innerHTML = jugadores.map(j => `<img src="${j.foto}" class="perfil-img">`).join('');
    }

    function iniciarJuego() {
        if(jugadores.length < 3) return alert("M√≠nimo 3 jugadores");
        partida = {
            obj: db[Math.floor(Math.random()*db.length)],
            espiaIdx: Math.floor(Math.random()*jugadores.length),
            turno: 0, vIdx: 0
        };
        mostrar('s-game'); 
        prepararTurno();
    }

    function prepararTurno() {
        const j = jugadores[partida.turno];
        document.getElementById('s-game').innerHTML = `
            <div class="card" onclick="revelar()">
                <h1 style="color:var(--p)">${j.nombre}</h1>
                <div style="font-size:5rem; margin:20px 0;">üïµÔ∏è‚Äç‚ôÇÔ∏è</div>
                <p>TOCA PARA VER TU SECRETO</p>
            </div>`;
    }

    function revelar() {
        const esE = (partida.turno === partida.espiaIdx);
        const j = jugadores[partida.turno];
        let icono = esE ? "‚ùì" : partida.obj.e;
        
        // Personalizaci√≥n para Hache y Jota
        if(esE && j.nombre.includes("HACHE")) icono = "üëÆ‚Äç‚ôÇÔ∏è";
        if(esE && j.nombre.includes("JOTA")) icono = "üë®‚Äçüöí";

        document.getElementById('s-game').innerHTML = `
            <div class="card" style="border: 8px solid ${esE ? 'var(--red)' : 'var(--p)'}">
                <div class="aura-color" style="background:${esE ? '#444' : partida.obj.c}">${icono}</div>
                <h2>${esE ? "¬°ERES EL ESP√çA!" : partida.obj.p}</h2>
                <p>${esE ? "¬°Finge que sabes la palabra!" : "¬°Que no te pillen!"}</p>
                <button class="btn" onclick="sigTurno()">LISTO ‚úÖ</button>
            </div>`;
    }

    function sigTurno() {
        partida.turno++;
        if(partida.turno < jugadores.length) prepararTurno();
        else { partida.vIdx = 0; lanzarVoto(); }
    }

    function lanzarVoto() {
        const votante = jugadores[partida.vIdx];
        let btns = jugadores.map((s, idx) => idx !== partida.vIdx ? `<button class="btn" onclick="votar(${idx})">${s.nombre}</button>` : "").join('');
        document.getElementById('s-game').innerHTML = `
            <div class="card">
                <h2>${votante.nombre}</h2>
                <p>¬øQui√©n crees que es el esp√≠a?</p>
                <div style="max-height:300px; overflow-y:auto;">${btns}</div>
            </div>`;
    }

    function votar(idx) {
        jugadores[idx].votos++;
        partida.vIdx++;
        if(partida.vIdx < jugadores.length) lanzarVoto();
        else finalizarRonda();
    }

    function finalizarRonda() {
        const culpable = [...jugadores].sort((a,b) => b.votos - a.votos)[0];
        const esE = (jugadores.indexOf(culpable) === partida.espiaIdx);
        
        if(esE) jugadores.forEach((j,i) => { if(i!==partida.espiaIdx) j.puntos+=10; });
        else jugadores[partida.espiaIdx].puntos+=20;

        document.getElementById('s-game').innerHTML = `
            <div id="regalo-seccion" style="text-align:center;">
                <h1 style="color:var(--gold)">¬°MIRA TU REGALO!</h1>
                <div class="regalo-anim" onclick="abrirRegalo()">üéÅ</div>
                <p>TOCA PARA VER EL RESULTADO FINAL</p>
            </div>
            <div id="podio-seccion" style="display:none; width:100%;">
                ${generarPodioHTML()}
            </div>`;
    }

    function generarPodioHTML() {
        const max = Math.max(...jugadores.map(j => j.puntos));
        const min = Math.min(...jugadores.map(j => j.puntos));
        const campeones = jugadores.filter(j => j.puntos === max);
        const perdedor = jugadores.find(j => j.puntos === min);

        return `
            <h1 style="color:var(--gold); margin-bottom:0;">üèÜ PODIO DE BAIL√âN</h1>
            <div class="podio-cont">
                ${campeones.map(c => `
                    <div class="ganador-final">
                        <div style="font-size:2.5rem;">ü•á</div>
                        <img src="${c.foto}">
                        <div style="background:var(--gold); color:black; font-weight:bold; border-radius:10px; padding:2px 10px;">${c.nombre}</div>
                    </div>
                `).join('')}
            </div>
            <div class="lagarto-escena">
                <div class="lagarto-img">ü¶é</div>
                <img src="${perdedor.foto}" class="perdedor-img">
                <div style="color:var(--red); font-weight:bold; background:rgba(0,0,0,0.7); border-radius:10px; padding:10px; margin-top:10px;">
                    ¬°EL LAGARTO DE JA√âN <br> SE COMI√ì A ${perdedor.nombre}!
                </div>
            </div>
            <button class="btn" onclick="reiniciarPuntos()">OTRA RONDA üîÑ</button>
            <button class="btn" style="background:#444" onclick="location.reload()">NUEVA PARTIDA</button>
        `;
    }

    function abrirRegalo() {
        document.getElementById('regalo-seccion').style.display = 'none';
        document.getElementById('podio-seccion').style.display = 'block';
    }

    function reiniciarPuntos() {
        jugadores.forEach(j => { j.votos = 0; });
        iniciarJuego();
    }
</script>
</body>
</html>
