<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Un EspÃ­a en AndalucÃ­a</title>
    <style>
        :root { --p: #2E7D32; --s: #81C784; --dark: #0b1a2a; --gold: #FFD700; }
        body { font-family: 'Segoe UI', sans-serif; text-align: center; margin: 0; background: var(--dark); color: white; overflow: hidden; }
        .screen { display: none; height: 100vh; flex-direction: column; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
        #s1 { background-image: url('inicio.jpeg'); background-size: cover; background-position: center; }
        .active { display: flex; }
        .card { background: white; color: #333; padding: 15px; border-radius: 20px; width: 95%; max-width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .btn { background: var(--p); color: white; border: none; padding: 12px; border-radius: 15px; font-size: 1rem; font-weight: bold; width: 85%; cursor: pointer; margin: 5px 0; }
        .perfil-img { width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--s); margin: 3px; }
        .puntos-tag { font-size: 0.8rem; background: var(--gold); color: black; padding: 2px 5px; border-radius: 5px; font-weight: bold; }
        .modo-box { background: #f0fdf4; padding: 10px; border-radius: 15px; border: 2px dashed var(--p); margin: 10px 0; }
        .contacto { font-size: 0.6rem; color: #ccc; margin-top: 5px; }
        #camera-feed { width: 100%; border-radius: 20px; transform: scaleX(-1); }
        .wanted-container { background-image: url('wanted_frame.png'); background-size: contain; background-repeat: no-repeat; background-position: center; width: 300px; height: 380px; display: flex; flex-direction: column; align-items: center; }
        .wanted-photo { width: 160px; height: 160px; margin-top: 95px; object-fit: cover; filter: sepia(0.6); }
        #canvas-final { max-width: 100%; border: 5px solid var(--gold); border-radius: 20px; }
    </style>
</head>
<body>

<div id="s1" class="screen active">
    <div style="background: rgba(0,0,0,0.75); padding: 15px; border-radius: 20px; width: 95%;">
        <h1 style="color:var(--s); margin:0; font-size: 1.8rem;">ğŸ•µï¸â€â™‚ï¸ Un EspÃ­a en AndalucÃ­a</h1>
        <div id="lista-jugadores" style="margin:10px 0;"></div>
        <input type="text" id="in-nombre" placeholder="Tu nombre..." style="padding:10px; border-radius:10px; width:80%; margin:10px 0;">
        <button class="btn" style="background:var(--s); color:black" onclick="abrirCamara()">ğŸ“¸ HACERSE SELFIE</button>
        <select id="select-nivel" style="padding:10px; width:85%; border-radius:10px;">
            <option value="exp">ğŸ¼ Exploradores (4-8 aÃ±os)</option>
            <option value="jun">ğŸ’ Junior (9-15 aÃ±os)</option>
            <option value="ado">ğŸ“± Adolescente (16-17 aÃ±os)</option>
            <option value="adu">ğŸ· Adultos (+18 aÃ±os)</option>
        </select>
        <button class="btn" onclick="iniciarJuego()" style="background:var(--gold); color:black; margin-top:10px;">Â¡REPARTIR ROLES! ğŸš€</button>
        <div class="contacto">ğŸ“© molinsan.jl@gmail.com | ğŸ’° paypal.me/7moli</div>
    </div>
</div>

<div id="s-cam" class="screen">
    <video id="camera-feed" autoplay playsinline></video>
    <button class="btn" onclick="tomarFoto()">CAPTURAR ğŸ“¸</button>
</div>

<div id="s2" class="screen">
    <div id="tap-card" class="card" onclick="revelarPalabra()">
        <h2 id="turno-de"></h2>
        <div style="font-size:3rem">ğŸ•µï¸â€â™‚ï¸</div>
        <p>TOCA PARA VER TU SECRETO</p>
    </div>
    <div id="info-card" class="card" style="display:none">
        <h3 id="msg-rol"></h3>
        <div id="box-imagen" style="font-size:5rem"></div>
        <h2 id="v-palabra" style="color:var(--p); margin:0;"></h2>
        <p id="pista-texto" style="font-style:italic; font-size:0.9rem; color:#666; margin-top:10px;"></p>
        <button class="btn" onclick="terminarTurno()">LISTO âœ…</button>
    </div>
</div>

<div id="s-misiones" class="screen">
    <div class="card">
        <h2 id="mision-jugador-nombre" style="margin:0"></h2>
        <p>ActÃºa de esta forma:</p>
        <div class="modo-box">
            <div id="mision-icon" style="font-size:3rem"></div>
            <div id="mision-texto" style="font-weight:bold; font-size:1.2rem;"></div>
        </div>
        <button class="btn" onclick="siguienteMision()">LO HE HECHO â–¶ï¸</button>
    </div>
</div>

<div id="s-voto" class="screen">
    <div class="card">
        <h2 id="votante-nombre"></h2>
        <div id="botones-voto"></div>
    </div>
</div>

<div id="s-wanted" class="screen">
    <div id="wanted-area" class="wanted-container">
        <img id="wanted-img" class="wanted-photo">
        <div id="wanted-nombre" style="font-weight:bold; color:#3d2b1f; margin-top:5px; font-family:serif;"></div>
    </div>
    <div class="card" style="margin-top:10px;">
        <div id="resultado-final"></div>
        <div id="tabla-puntos" style="font-size:0.8rem; margin:10px 0; font-weight:bold;"></div>
        <button class="btn" onclick="iniciarJuego()">OTRA RONDA ğŸ”„</button>
        <button class="btn" style="background:#444" onclick="generarPodium()">TERMINAR Y PODIO ğŸ†</button>
    </div>
</div>

<div id="s-final" class="screen">
    <h2 style="color:var(--gold); margin-bottom:10px;">ğŸ† CAMPEONES EN JAÃ‰N</h2>
    <canvas id="canvas-final" width="600" height="400"></canvas>
    <button class="btn" style="margin-top:15px;" onclick="location.reload()">NUEVA PARTIDA</button>
</div>

<script>
    // ConfiguraciÃ³n de Palabras y Pistas
    const db = {
        exp: [{p:"GATO",e:"ğŸ±",pi:"Es un animal que hace miau"}, {p:"SOL",e:"â˜€ï¸",pi:"Sale por el dÃ­a y calienta"}, {p:"PELOTA",e:"âš½",pi:"Es redonda y sirve para jugar"}],
        jun: [{p:"PIRATA",e:"ğŸ´â€â˜ ï¸",pi:"Busca tesoros con un mapa"}, {p:"ROBOT",e:"ğŸ¤–",pi:"Se mueve con pilas y es de metal"}, {p:"CHEF",e:"ğŸ‘¨â€ğŸ³",pi:"Prepara comida en un restaurante"}],
        ado: [{p:"TIKTOK",e:"ğŸ’ƒ",pi:"App de retos y bailes virales"}, {p:"EXAMEN",e:"ğŸ“",pi:"Te pone nota el profesor"}, {p:"CONCIERTO",e:"ğŸ¸",pi:"Vas a ver a tu cantante favorito"}],
        adu: [{p:"HIPOTECA",e:"ğŸ ",pi:"Dinero que le debes al banco"}, {p:"RESACA",e:"ğŸ¤¢",pi:"Malestar despuÃ©s de una fiesta"}, {p:"LAVADORA",e:"ğŸ§º",pi:"ElectrodomÃ©stico para la ropa"}]
    };

    const misiones = [
        {t:"CÃ¡mara Lenta",i:"ğŸŒ"},{t:"Como Robot",i:"ğŸ¤–"},{t:"Bailando",i:"ğŸ’ƒ"},
        {t:"Sin usar manos",i:"ğŸ–ï¸ğŸš«"},{t:"Muy rÃ¡pido",i:"ğŸƒ"},{t:"A la pata coja",i:"ğŸ¦©"}
    ];
    
    let jugadores = [];
    let partida = {};
    let stream;

    function abrirCamara() {
        if(!document.getElementById('in-nombre').value) return alert("Pon tu nombre");
        mostrar('s-cam');
        navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}}).then(s => {
            stream = s; document.getElementById('camera-feed').srcObject = s;
        });
    }

    function tomarFoto() {
        const canvas = document.createElement('canvas');
        canvas.width=300; canvas.height=300;
        canvas.getContext('2d').drawImage(document.getElementById('camera-feed'),0,0,300,300);
        jugadores.push({nombre:document.getElementById('in-nombre').value.toUpperCase(), foto:canvas.toDataURL(), puntos:0, votos:0});
        stream.getTracks().forEach(t=>t.stop());
        document.getElementById('in-nombre').value = "";
        actualizarLista(); mostrar('s1');
    }

    function actualizarLista() {
        document.getElementById('lista-jugadores').innerHTML = jugadores.map(j => `<span><img src="${j.foto}" class="perfil-img"><br><b class="puntos-tag">${j.puntos}</b></span>`).join('');
    }

    function iniciarJuego() {
        if(jugadores.length < 3) return alert("NecesitÃ¡is ser al menos 3");
        const nivel = document.getElementById('select-nivel').value;
        const obj = db[nivel][Math.floor(Math.random()*db[nivel].length)];
        jugadores.forEach(j => j.votos = 0);
        partida = {
            obj, espiaIdx: Math.floor(Math.random()*jugadores.length),
            turno: 0, mTurno: 0, vIdx: 0,
            mAsignadas: jugadores.map((_,i) => misiones[i % misiones.length]).sort(()=>0.5-Math.random())
        };
        mostrar('s2'); prepararTurno();
    }

    function prepararTurno() {
        document.getElementById('turno-de').innerText = "TURNO: " + jugadores[partida.turno].nombre;
        document.getElementById('tap-card').style.display = "block";
        document.getElementById('info-card').style.display = "none";
    }

    function revelarPalabra() {
        const esE = (partida.turno === partida.espiaIdx);
        document.getElementById('tap-card').style.display = "none";
        document.getElementById('info-card').style.display = "block";
        document.getElementById('msg-rol').innerText = esE ? "ğŸ¤« ERES EL ESPÃA" : "TU PALABRA:";
        document.getElementById('box-imagen').innerText = esE ? "â“" : partida.obj.e;
        document.getElementById('v-palabra').innerText = esE ? "Â¡AVERÃGUALO!" : partida.obj.p;
        document.getElementById('pista-texto').innerText = esE ? "PISTA: " + partida.obj.pi : "";
    }

    function terminarTurno() {
        partida.turno++;
        if(partida.turno < jugadores.length) prepararTurno();
        else { partida.mTurno = 0; mostrarMision(); }
    }

    function mostrarMision() {
        mostrar('s-misiones');
        const j = jugadores[partida.mTurno]; const m = partida.mAsignadas[partida.mTurno];
        document.getElementById('mision-jugador-nombre').innerText = j.nombre;
        document.getElementById('mision-icon').innerText = m.i;
        document.getElementById('mision-texto').innerText = m.t;
    }

    function siguienteMision() {
        partida.mTurno++;
        if(partida.mTurno < jugadores.length) mostrarMision();
        else { partida.vIdx = 0; mostrar('s-voto'); lanzarVoto(); }
    }

    function lanzarVoto() {
        const votante = jugadores[partida.vIdx];
        document.getElementById('votante-nombre').innerText = votante.nombre + " Â¿QuiÃ©n es el espÃ­a?";
        const box = document.getElementById('botones-voto'); box.innerHTML = "";
        jugadores.forEach((s, idx) => {
            if(idx !== partida.vIdx) {
                const b = document.createElement('button'); b.className="btn"; b.innerText=s.nombre;
                b.onclick = () => { jugadores[idx].votos++; partida.vIdx++; if(partida.vIdx < jugadores.length) lanzarVoto(); else finalizar(); };
                box.appendChild(b);
            }
        });
    }

    function finalizar() {
        const culpable = [...jugadores].sort((a,b) => b.votos - a.votos)[0];
        const esE = (jugadores.indexOf(culpable) === partida.espiaIdx);
        document.getElementById('wanted-img').src = culpable.foto;
        document.getElementById('wanted-nombre').innerText = culpable.nombre;
        if(esE) { 
            jugadores.forEach((j, i) => { if(i !== partida.espiaIdx) j.puntos += 10; });
            document.getElementById('resultado-final').innerHTML = "<h3>Â¡PILLADO! +10 pts para los demÃ¡s</h3>";
        } else {
            jugadores[partida.espiaIdx].puntos += 20;
            document.getElementById('resultado-final').innerHTML = "<h3>Â¡SE ESCAPÃ“! +20 pts para el espÃ­a</h3>";
        }
        document.getElementById('tabla-puntos').innerText = "MARCADOR: " + jugadores.map(j=>j.nombre+":"+j.puntos).join(" | ");
        mostrar('s-wanted');
    }

    function generarPodium() {
        mostrar('s-final');
        const canvas = document.getElementById('canvas-final');
        const ctx = canvas.getContext('2d');
        const maxPts = Math.max(...jugadores.map(j => j.puntos));
        const ganadores = jugadores.filter(j => j.puntos === maxPts);

        const bg = new Image();
        bg.src = 'inicio.jpeg'; 
        bg.onload = () => {
            ctx.drawImage(bg, 0, 0, 600, 400);
            ctx.fillStyle = "rgba(0,0,0,0.6)";
            ctx.fillRect(0,0,600,400);
            
            ganadores.forEach((g, i) => {
                const img = new Image();
                img.src = g.foto;
                img.onload = () => {
                    const x = (600 / (ganadores.length + 1)) * (i + 1) - 75;
                    ctx.save();
                    ctx.beginPath();
                    ctx.arc(x+75, 180, 75, 0, Math.PI*2);
                    ctx.clip();
                    ctx.drawImage(img, x, 105, 150, 150);
                    ctx.restore();
                    
                    ctx.font = "60px Arial";
                    ctx.fillText("ğŸ†", x + 100, 150);
                    ctx.fillStyle = "white";
                    ctx.font = "bold 25px Arial";
                    ctx.textAlign = "center";
                    ctx.fillText(g.nombre, x+75, 290);
                    ctx.fillStyle = "#FFD700";
                    ctx.fillText(g.puntos + " PUNTOS", x+75, 330);
                };
            });
        };
    }

    function mostrar(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }
</script>
</body>
</html>



